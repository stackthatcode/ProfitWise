

<script>
    ProfitWiseWidgets.MasterProductFilterModel = function (parent) {
        var self = this;
        self.ReportId = ko.observable();
        self.ParentReportModel = parent;
        self.FilterType = self.ParentReportModel.ProductFilter;

        // Data
        self.CurrentPageOfItems = ko.observableArray();
        
        // Paging and Filtering model
        self.FilterModel = new ProfitWiseWidgets.FilterPagingWidgetModel();
        self.FilterModel.PlaceHolderText("Search for Products by Title or Vendor...");
        self.FilterModel.RegisterRefreshCallback(function () {
            self.ApplyFiltersAndPaging();
        });
        self.FilterModel.SetPageSize(50);

        // Selection Model
        self.UpdateCallback = function (item, selected) {
            self.ParentReportModel.UpdateFilter(
                item.Key, selected, self.FilterType, item.Title);
        };

        self.SelectionModel = new ProfitWiseWidgets.SelectionModel();
        self.SelectionModel.RegisterUpdateCallback(self.UpdateCallback);
        
        self.SelectionModel.SearchTextFunction = function (item, searchText) {
            return ProfitWiseFunctions.CaseInsensitiveContains(item.Title, searchText) ||
                ProfitWiseFunctions.CaseInsensitiveContains(item.Vendor, searchText);
        };

        self.DeselectAll = function () {
            self.ParentReportModel.RemoveFilterType(self.FilterType);
            self.SelectionModel.ShowSplashPage(true);
        }

        self.Refresh = function (callback) {
            self.FilterModel.SetPageNumber(1);
            var ajax = new ProfitWiseFunctions.Ajax();

            flow.exec(
                function () {
                    ajax.HttpGet("/ReportService/MasterProducts?reportId=" + self.ReportId(), this);
                },
                function (allItemsFromServer) {
                    self.SelectionModel.LoadItems(allItemsFromServer);                   
                    self.ApplyFiltersAndPaging();
                    callback();
                }
            );
        }

        // Common functions should be same across all Report Editor Models
        self.HideSplashPage = function () {
            self.SelectionModel.ShowSplashPage(false);
            self.FilterModel.SearchText("");
            self.FilterModel.SearchClick();
        };

        self.ApplyFiltersAndPaging = function () {
            var filterResults =
                self.SelectionModel.ApplyFiltersAndPaging(
                    self.FilterModel.SearchText(), self.FilterModel.GetPageNumber(), self.FilterModel.GetPageSize());
            
            self.FilterModel.SetRecordCount(filterResults.NumberOfFilteredItems);
            self.CurrentPageOfItems(filterResults.PagedItems);
        };

        return self;
    };
</script>
