
<script type="text/html" id="Report-Editor-Header-Master-Product">
    <!--<div data-bind="if: SelectionModel.ShowSplashPage">
        <div data-bind="template: { name: 'Report-Editor-No-Filters',
                        data: { clickCallback:  HideSplashPage, plural: 'Products', singular: 'Product' } }">
        </div>
    </div>-->

    <div>
        <div class="row-fluid">
            <div class="col-xs-12 no-side-padding" style="height: 120px;">
                <div class="pull-right" data-bind="template: { name: 'Filter-Paging-Widget', data: $data.FilterModel }"></div>
            </div>
        </div>

        <div class="row-fluid">
            <div class="col-xs-12 no-side-padding">
                <div style="width: 100%; border-top: 1px dashed #CCC;"></div>
                <a href="#" style="position: absolute; top: -40px; font-weight: 700;"
                   data-bind="click: DeselectAll">Remove Product Filters</a>
            </div>
        </div>
    </div>
</script>

<script type="text/html" id="Report-Editor-Body-Master-Product">
    <div class="row-fluid" style="min-height: 400px;">
        <div class="col-xs-7 reduced-padding">
            <div data-bind="if: PageOfItems().length == 0">
                <div data-bind="template: { name: 'Report-Editor-Empty-Results', data: { ItemDescription: 'Products' } }"></div>
            </div>

            <div data-bind="if: PageOfItems().length > 0">
                <table id="product-types" class="table table-hover" style="width: 100%; height: 100%; margin: 0;">
                    <tbody data-bind="foreach: PageOfItems">
                        <tr style="border-top: 0;" data-bind="click: $data.SelectChange">
                            <td style="color:#777;">
                                <div data-bind="if: $data.IsChecked">
                                    <i class="glyphicon glyphicon-ok"></i>
                                </div>
                                <div data-bind="ifnot: $data.IsChecked">
                                </div>
                            </td>

                            <td style="width:60%;" class="overflow-gracefully">
                                <span data-bind="text: $data.Title, tooltip: { title: $data.Title }"></span>
                                <br />
                                <span data-bind="text: $data.Vendor" style="font-size:0.8em; font-weight:700; color:#666;"></span>
                            </td>

                            <td style="width:30%;">(<span data-bind="text: $data.VariantCount"></span> Variants)</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="col-xs-4">
        </div>
    </div>
</script>

<script>
    ProfitWiseWidgets.MasterProductFilterModel = function (parent) {
        var self = this;
        self.ReportId = ko.observable();
        self.ParentReportModel = parent;
        self.FilterType = self.ParentReportModel.ProductFilter;

        // Data
        self.PageOfItems = ko.observableArray();
        
        // Paging and Filtering model
        self.FilterModel = new ProfitWiseWidgets.FilterPagingWidgetModel();
        self.FilterModel.PlaceHolderText("Search for Products by Title or Vendor...");
        self.FilterModel.RegisterRefreshCallback(function () {
            self.ApplyFiltersAndPaging();
        });
        self.FilterModel.SetPageSize(50);

        // Selection Model
        self.UpdateCallback = function (item, selected) {
            self.ParentReportModel.UpdateFilter(
                item.Key, selected, self.FilterType, item.Title);
        };

        self.SelectionModel = new ProfitWiseWidgets.SelectionModel();
        self.SelectionModel.RegisterUpdateCallback(self.UpdateCallback);
        
        self.SelectionModel.SearchTextFunction = function (item, searchText) {
            return ProfitWiseFunctions.CaseInsensitiveContains(item.Title, searchText) ||
                ProfitWiseFunctions.CaseInsensitiveContains(item.Vendor, searchText);
        };

        self.DeselectAll = function () {
            self.ParentReportModel.RemoveFilterType(self.FilterType);
            self.SelectionModel.ShowSplashPage(true);
        }

        self.Refresh = function (callback) {
            self.FilterModel.SetPageNumber(1);
            var ajax = new ProfitWiseFunctions.Ajax();

            flow.exec(
                function () {
                    ajax.HttpGet("/ReportService/MasterProducts?reportId=" + self.ReportId(), this);
                },
                function (allItemsFromServer) {
                    self.SelectionModel.LoadItems(allItemsFromServer);                   
                    self.ApplyFiltersAndPaging();
                    callback();
                }
            );
        }

        // Common functions should be same across all Report Editor Models
        self.HideSplashPage = function () {
            self.SelectionModel.ShowSplashPage(false);
            self.FilterModel.SearchText("");
            self.FilterModel.SearchClick();
        };

        self.ApplyFiltersAndPaging = function () {
            var filterResults =
                self.SelectionModel.ApplyFiltersAndPaging(
                    self.FilterModel.SearchText(), self.FilterModel.GetPageNumber(), self.FilterModel.GetPageSize());

            self.FilterModel.SetRecordCount(filterResults.NumberOfFilteredItems);
            self.PageOfItems(filterResults.PagedItems);
        };

        return self;
    };
</script>
