@using ProfitWise.Data.Model.GoodsOnHand
@using ProfitWise.Data.Model.Reports

<style>
    .report-viewer-top-button {
        width: 130px;
    }

    .report-widget-label {
        font-weight: 700;
        color: #AAA;
        font-size: 1.2em;
    }

    .report-widget-drilldown-link {
        font-weight:700; 
        margin-top:10px;
        display: inline-block;
    }

    .profit-table tr td:nth-child(1), .profit-table tr th:nth-child(1)  {
        width:25%;
        text-align:left;
    }
    .profit-table tr td:nth-child(2), .profit-table tr th:nth-child(2)  {
        width:20%;
        text-align:right;
    }
    .profit-table tr td:nth-child(3), .profit-table tr th:nth-child(3)  {
        width:20%;
        text-align:right;
    }
    .profit-table tr td:nth-child(4), .profit-table tr th:nth-child(4)  {
        width:20%;
        text-align:right;
    }
    .profit-table tr td:nth-child(5), .profit-table tr th:nth-child(5)  {
        width:20%;
        text-align:right;
    }

    .executive-summary h1 {
        font-weight: 700;
        margin-top: 6px;
    }
    .executive-summary-label {
        font-weight: 700;
        color: #999;
        font-size:18p
    }
    .executive-summary .summary-cell {
        text-align: left;
    }

    .summary-header {
        text-align:center; border-bottom:1px dashed #CCC; overflow:auto;
    }

    .pie-chart {
        min-width: 310px; height: 400px; max-width: 600px;margin: 0 auto;clear: both;
    }

    #detail-report-table tr td:nth-child(1), #detail-report-table tr th:nth-child(1) {
        width: 22%;
    }

    #detail-report-table tr td:nth-child(2), #detail-report-table tr th:nth-child(2) {
        width: 14%;
        text-align: right;
    }

    #detail-report-table tr td:nth-child(3), #detail-report-table tr th:nth-child(3) {
        width: 14%;
        text-align: right;
    }

    #detail-report-table tr td:nth-child(4), #detail-report-table tr th:nth-child(4) {
        width: 13%;
        text-align: right;
    }

    #detail-report-table tr td:nth-child(5), #detail-report-table tr th:nth-child(5) {
        width: 13%;
        text-align: right;
    }

    #detail-report-table tr td:nth-child(6), #detail-report-table tr th:nth-child(6) {
        width: 13%;
        text-align: right;
    }

    #detail-report-table tr td:nth-child(7), #detail-report-table tr th:nth-child(7) {
        width: 11%;
        text-align: right;
    }
</style>

<!-- Profitability Views -->
<script id="Report-Goods-On-Hand" type="text/html">
    <div data-bind="ifnot: DatasetLoaded">
        <div style="min-height: 600px;">
            <h1 style="margin-top: 100px; text-align: center; font-weight: 700; font-size: 6em; color: #EEE;">
                No Report Loaded Yet
            </h1>
        </div>
    </div>
    
    <div data-bind="if: DatasetLoaded">
        <div style="min-height: 600px;">            
            <!-- Executive Summary -->            
            <div data-bind="template: { name: 'Report-Goods-On-Hand-Totals' }"></div>

            <!-- Table -->
            <div data-bind="template: { name: 'Report-Goods-On-Hand-Details'  }"></div>

        </div>

    </div>
</script>
<script id="Report-Goods-On-Hand-Totals" type="text/html">
    <!-- Executive Summary -->
    <div class="row executive-summary" data-bind="with: Data">        
        <div class="col-xs-3 summary-cell">
            <div class="executive-summary-label">Cost of Goods on Hand</div>
            <h1 data-bind="text: ProfitWiseFunctions.FormatCurrency(Totals.TotalCostOfGoodsOnHand, CurrencyId)"></h1>
        </div>
        <div class="col-xs-3 summary-cell">
            <div class="executive-summary-label">Potential Revenue</div>
            <h1 data-bind="text: ProfitWiseFunctions.FormatCurrency(Totals.TotalPotentialRevenue, CurrencyId)"></h1>
        </div>
        <div class="col-xs-3 summary-cell">
            <div class="executive-summary-label">Potential Profit</div>
            <h1 data-bind="text: ProfitWiseFunctions.FormatCurrency(Totals.TotalPotentialProfit, CurrencyId)"></h1>
        </div>
        <div class="col-xs-3 summary-cell">
        </div>
    </div>

    <!-- Spacer -->
    <div class="row">
        <div class="col-xs-12" style="height:25px; overflow:auto;">
        </div>
    </div>
</script>

<script id="Report-Goods-On-Hand-Details" type="text/html">
    <div data-bind="if: Data().Details.length > 0 && PagingModel.PageCount() > 0" style="text-align: right;">
        <div style="overflow:auto; margin-bottom: 60px;" 
             data-bind="template: { name: 'Paging-Widget', data: PagingModel }">
        </div>
    </div>
    
    <div data-bind="if: Data().Details.length > 0">
        <table class="table table-striped table-hover" id="detail-report-table">
            <thead>
            <tr>
                <th>Name</th>
                <th style="text-align: center;">Unit Price</th>
                <th data-bind="template: { name: 'Sortable-Column-Header',
                                data: { ColumnIndex: 0, ColumnName: '# In Stock', Model: SortingModel } }"></th>
                <th data-bind="template: { name: 'Sortable-Column-Header',
                                data: { ColumnIndex: 1, ColumnName: 'Total CoGS', Model: SortingModel } }"></th>
                <th data-bind="template: { name: 'Sortable-Column-Header',
                                data: { ColumnIndex: 2, ColumnName: 'Potential Revenue', Model: SortingModel } }"></th>
                <th data-bind="template: { name: 'Sortable-Column-Header',
                                data: { ColumnIndex: 3, ColumnName: 'Potential Profit', Model: SortingModel } }"></th>
            </tr>
            </thead>
            
            <!-- ko with: Data() -->
            <tbody data-bind="foreach: Details">
            <tr>
                <td>
                    <div class="overflow-gracefully" style="max-width:350px;"
                         data-bind="text: GroupingNameCleaned, tooltip: { title: GroupingNameCleaned, placement: 'bottom' }"></div>
                </td>

                <td style="text-align: center;">
                    <div data-bind="if: MinimumPrice != MaximumPrice">
                        <span class="overflow-gracefully"
                              data-bind="text: ProfitWiseFunctions.FormatCurrency(MinimumPrice, $parent.CurrencyId)"></span>
                        to
                        <span class="overflow-gracefully"
                              data-bind="text: ProfitWiseFunctions.FormatCurrency(MaximumPrice, $parent.CurrencyId)"></span>
                    </div>
                    <div data-bind="if: MinimumPrice == MaximumPrice">
                        <span class="overflow-gracefully"
                              data-bind="text: ProfitWiseFunctions.FormatCurrency(MaximumPrice, $parent.CurrencyId)"></span>
                    </div>
                </td>

                <td>
                    <span class="overflow-gracefully"
                          data-bind="text: TotalInventory"></span>
                </td>

                <td>
                    <span class="overflow-gracefully"
                          data-bind="text: ProfitWiseFunctions.FormatCurrency(TotalCostOfGoodsSold, $parent.CurrencyId)"></span>
                </td>
                <td>
                    <span class="overflow-gracefully"
                          data-bind="text: ProfitWiseFunctions.FormatCurrency(TotalPotentialRevenue, $parent.CurrencyId)"></span>
                </td>
                <td>
                    <span class="overflow-gracefully"
                          data-bind="text: ProfitWiseFunctions.FormatCurrency(TotalPotentialProfit, $parent.CurrencyId)"></span>
                </td>
            </tr>
            </tbody>
            <!-- /ko -->
        </table>
    </div>

    <div data-bind="if: Data().Details.length > 0 && PagingModel.PageCount() > 0" style="text-align: right;">
        <div style="overflow:auto; margin-top: 60px;"
             data-bind="template: { name: 'Paging-Widget', data: PagingModel }">
        </div>
    </div>
</script>



<script id="Goods-On-Hand-Model">
    ProfitWiseWidgets.GoodsOnHandModel = function () {
        var self = this;
        self.ReportId = ko.observable();
        self.Data = ko.observable();
        self.DatasetLoaded = ko.observable(false);

        self.PagingModel = new ProfitWiseWidgets.PagingModel();
        self.PagingModel.Callback = function () { self.RefreshReportData(self.ReportId()); };
        self.PagingModel.ShowPageSizeSelector(true);
        self.PagingModel.PageNumber(1);

        self.SortingModel = new ProfitWiseWidgets.SortingModel();
        self.SortingModel.Callback = function () { self.RefreshReportData(self.ReportId()); };
        self.SortingModel.SelectedColumnIndex(1);   // Default to CoGS descending...

        self.Ordering = ko.computed(function () {
            var index = self.SortingModel.SelectedColumnIndex();
            var descending = self.SortingModel.SortByDirectionDown();

            if (index == 0)
                return descending ?
                    '@ColumnOrdering.InventoryDescending' : '@ColumnOrdering.InventoryAscending';
            if (index == 1)
                return descending ?
                    '@ColumnOrdering.CogsDescending' : '@ColumnOrdering.CogsAscending';
            if (index == 2)
                return descending ?
                    '@ColumnOrdering.PotentialRevenueDescending' : '@ColumnOrdering.PotentialRevenueAscending';
            if (index == 3)
                return descending ?
                    '@ColumnOrdering.PotentialProfitDescending' : '@ColumnOrdering.PotentialProfitAscending';

            return '@ColumnOrdering.CogsDescending';
        });


        self.RefreshReportData = function (reportId, callback) {
            flow.exec(
                function () {
                    var data = {
                        reportId: reportId,
                        ordering: self.Ordering(),
                        pageNumber: self.PagingModel.PageNumber(),
                        pageSize: self.PagingModel.PageSize(),
                    };
                    var ajax = new ProfitWiseFunctions.Ajax();
                    ajax.HttpPost("/GoodsOnHandService/Data", data, this);
                },
                function (data) {
                    self.ReportId(reportId);

                    //console.log(data);

                    self.Data(data);
                    self.PagingModel.RecordCount(data.DetailsCount);

                    $('html, body').animate({ scrollTop: 0 });

                    /*
                    ProfitWiseWidgets.LoadColumnChart(
                        '#column-chart', 'Profitability', data.Series, data.Drilldown, data.CurrencyId);

                    if (data.Summary.ExecutiveSummary.TotalQuantitySold > 0) {
                        ProfitWiseWidgets.LoadPieChart('products-pie-chart', 'Top Products', summary.ProductsByMostProfitable, data.CurrencyId);
                        ProfitWiseWidgets.LoadPieChart('vendors-pie-chart', 'Top Vendors', summary.VendorsByMostProfitable, data.CurrencyId);
                        ProfitWiseWidgets.LoadPieChart('variants-pie-chart', 'Top Variants', summary.VariantByMostProfitable, data.CurrencyId);
                        ProfitWiseWidgets.LoadPieChart('product-types-pie-chart', 'Top Product Types', summary.ProductTypeByMostProfitable, data.CurrencyId);
                    }
                    */

                    self.DatasetLoaded(true);

                    if (callback) {
                        callback();
                    }
                }
            );
        };

        return self;
    };
</script>
