@using ProfitWise.Data.Model.Reports
@using Push.Foundation.Web.Json

@Html.Partial("~/Views/SharedTemplates/_SelectorPopoverWidget.cshtml")

<style>
    table#product-types td {
        height: 70px !important;
        font-size: 14px;
        vertical-align: middle !important;
    }
    table#product-types tr td:nth-child(1) {
        width: 10%;
    }
    table#product-types tr td:nth-child(2) {
        width: 45%;
    }
    table#product-types tr td:nth-child(3) {
        width: 45%;
    }

    .report-viewer-top-button {
        width: 130px;
    }

    .report-widget-label {
        font-weight: 700;
        color: #AAA;
    }

    .profit-table tr td:nth-child(1), .profit-table tr th:nth-child(1)  {
        width:25%;
        text-align:left;
    }
    .profit-table tr td:nth-child(2), .profit-table tr th:nth-child(2)  {
        width:20%;
        text-align:right;
    }
    .profit-table tr td:nth-child(3), .profit-table tr th:nth-child(3)  {
        width:20%;
        text-align:right;
    }
    .profit-table tr td:nth-child(4), .profit-table tr th:nth-child(4)  {
        width:20%;
        text-align:right;
    }
    .profit-table tr td:nth-child(5), .profit-table tr th:nth-child(5)  {
        width:20%;
        text-align:right;
    }

    .executive-summary h1 {
        font-weight: 700;
        margin-top: 6px;
    }
    .executive-summary-label {
        font-weight: 700;
        color: #999;
    }
</style>

<script id="Report-Viewer-Top-Level" type="text/html">
    <div id="report-viewer-header" style="width: 100%; padding-left: 20px; padding-right: 20px;">
        <div class="standard-header-sleeve" style="height: 190px; border-bottom: 1px solid #FFF;">

            <!-- This element will track with the scrollbar via JavaScript wiring to onscroll-->
            <div class="standard-header standard-padding top-border-facade" style="overflow: visible; padding-top:20px;">
                <div class="col-xs-6 no-side-padding">
                    <div data-bind="if: ReportViewerContext.ReportLoaded()">
                        <div data-bind="template: { name: 'Report-Viewer-Context-Summary', 
                                                    data: $data.ReportViewerContext }">
                        </div>
                    </div>
                </div>

                <div class="col-xs-6 no-side-padding" style="padding-top:10px; min-width:500px;">
                    <div class="btn-group pull-right" 
                         data-bind="template: { name: 'Report-Viewer-Report-Selector', 
                                                    data: { SystemDefinedReports: $data.SystemDefinedReports,
                                                            UserDefinedReports: $data.UserDefinedReports,
                                                            SelectReportClick: $data.SelectReportClick} }">
                    </div>
                    
                    <div class="pull-right" data-bind="with: ReportViewerContext">
                        <div data-bind="if: OnlySaveAsAllowed">

                            <div class="pull-right" style="margin-right: 7px;">
                                <a href="#" data-bind="click: SaveAs" class="btn btn-primary report-viewer-top-button">
                                    Save As &nbsp;<i class="glyphicon glyphicon-floppy-disk"></i>
                                </a>
                            </div>
                        </div>

                        <div data-bind="ifnot: OnlySaveAsAllowed">
                            <div class="pull-right" style="margin-right: 7px;">
                                <a href="#" data-bind="click: Save" class="btn btn-primary report-viewer-top-button">
                                    Save &nbsp;<i class="glyphicon glyphicon-floppy-disk"></i>
                                </a>
                            </div>
                            <div class="pull-right btn-group" style="margin-right: 7px;">
                                <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">...</button>

                                <ul class="dropdown-menu">
                                    <li><a href="#" data-bind="click: SaveAs">Save As</a></li>
                                    <li><a href="#" data-bind="click: Delete">Delete</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>                    

                    <div style="clear: both; height: 20px;"></div>                    
                    
                    <div id="report-date-picker" class="pull-right" data-bind="with: ReportViewerContext">
                        <input type="hidden" data-bind="value: StartDate"/>
                        <div data-bind="template: { name: 'Date-Picker-Widget', afterRender: AfterRenderDateRangePicker }"></div>
                    </div>

                    <div class="pull-right">
                        <a href="#" style="margin-right: 7px;"
                           class="btn btn-default report-viewer-top-button" data-bind="click: EditReportClick">
                            Edit Filters &nbsp;<i class="glyphicon glyphicon-filter"></i>
                        </a>
                    </div>
                </div>               
            </div>
        </div>
    </div>

    <div id="report-viewer-body" class="container page-content-sleeve">
        <div class="page-content" style="padding-top: 0px; overflow: auto; margin-top:0px;">

            <!-- TODO : allow injection of external template -->
            <div style="position: relative; width: 100%;">
                <div data-bind="template: { name: 'Report-Viewer-Dashboard' }"></div>           
            </div>
        </div>
    </div>
</script>

<script id="Report-Viewer-Dashboard" type="text/html">   
    <div data-bind="ifnot: ReportDashboardContext.DatasetLoaded">
        <div style="min-height: 600px;">
            <h1 style="margin-top: 100px; text-align:center; font-weight:700; font-size:6em; color:#EEE;">No Report Loaded Yet</h1>
        </div>
    </div>

    <div data-bind="if: ReportDashboardContext.DatasetLoaded">
        <div style="min-height: 600px" 
             data-bind="template: { name: 'Report-Viewer-Summary-Section', data: $data }">
        </div>
    </div>
</script>

<script id="Report-Viewer-Summary-Section" type="html/text">
    <!-- Executive Summary -->
    <div class="row executive-summary" data-bind="with: ReportDashboardContext.SummaryDataset">
        <div class="col-xs-3">
            <div class="executive-summary-label">Number of Orders</div>
            <h1 data-bind="text: ExecutiveSummary.TotalNumberSold"></h1>
        </div>
        <div class="col-xs-3">
            <div class="executive-summary-label">Revenue</div>
            <h1 data-bind="text: ProfitWiseFunctions.FormatCurrency(ExecutiveSummary.TotalRevenue, $data.CurrencyId)"></h1>
        </div>
        <div class="col-xs-3">
            <div class="executive-summary-label">Cost of Goods Sold</div>
            <h1 data-bind="text: ProfitWiseFunctions.FormatCurrency(ExecutiveSummary.TotalCogs, $data.CurrencyId)"></h1>
        </div>
        <div class="col-xs-3">
            <div class="executive-summary-label">Profit</div>
            <h1 data-bind="text: ProfitWiseFunctions.FormatCurrency(ExecutiveSummary.TotalProfit, $data.CurrencyId)"></h1>
        </div>
    </div>

    <!-- Spacer -->
    <div class="row">
        <div class="col-xs-12" style="height:25px; overflow:auto;">
        </div>
    </div>

    <!-- Column Chart with drilldown -->
    <div class="row">
        <div class="col-xs-12" style="overflow:auto;">
            <div style="text-align:center;">
                <h4 style="font-weight:700; color:#AAA;">Profits by Time Period</h4>
                <span>Grouped by </span>
                <span data-bind="template: { name: 'Selector-Popover-Widget', data: ReportViewerContext.GroupingPopoverModel }">
                </span>
                <!--<span>/</span>
                <span>Ordered by </span>
                <span data-bind="template: { name: 'Selector-Popover-Widget', data: ReportViewerContext.OrderingPopoverModel }">
                </span>-->
            </div>
            <div id="column-chart" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
        </div>
    </div>

    <!-- Spacer -->
    <div class="row">
        <div class="col-xs-12" style="height:50px; overflow:auto;">
        </div>
    </div>

    <!-- Pie Charts -->
    <div data-bind="with: ReportDashboardContext.SummaryDataset">
        <div data-bind="if: ExecutiveSummary.TotalNumberSold > 0">
            <div class="row">
                <div class="col-xs-6">
                    <div>
                        <span class="report-widget-label">Top Performing Products</span>
                        <a href="#" class="btn btn-primary pull-right" style="width:200px;">
                            <i class="glyphicon glyphicon-zoom-in"></i>&nbsp; Product Detail
                        </a>
                    </div>
                    <div id="products-pie-chart"
                            style="min-width: 310px; height: 400px; max-width: 600px; margin: 0 auto">
                    </div>
                    <div data-bind="template: { name: 'Report-Profit-Summary-Widget',
                                        data: { ProfitData: ProductsByMostProfitable,
                                                CurrencyId: CurrencyId } }">
                    </div>
                </div>

                <div class="col-xs-6">
                    <div>
                        <span class="report-widget-label">Top Performing Vendors</span>
                        <a href="#" class="btn btn-primary pull-right" style="width:200px;">
                            <i class="glyphicon glyphicon-zoom-in"></i>&nbsp; Vendor Detail
                        </a>
                    </div>
                    <div id="vendors-pie-chart"
                            style="min-width: 310px; height: 400px; max-width: 600px; margin: 0 auto">
                    </div>
                    <div data-bind="template: { name: 'Report-Profit-Summary-Widget',
                                        data: { ProfitData: VendorsByMostProfitable,
                                                CurrencyId: CurrencyId } }">
                    </div>
                </div>
            </div>
            <!-- Spacer -->
            <div class="row">
                <div class="col-xs-12" style="height:50px; overflow:auto;">
                </div>
            </div>

            <div class="row">
                <div class="col-xs-6">
                    <div>
                        <span class="report-widget-label">Top Performing Variants</span>
                        <a href="#" class="btn btn-primary pull-right" style="width:200px;">
                            <i class="glyphicon glyphicon-zoom-in"></i>&nbsp; Variant Detail
                        </a>
                    </div>
                    <div id="variants-pie-chart"
                            style="min-width: 310px; height: 400px; max-width: 600px; margin: 0 auto">
                    </div>
                    <div data-bind="template: { name: 'Report-Profit-Summary-Widget',
                                            data: { ProfitData: VariantByMostProfitable,
                                                    CurrencyId: CurrencyId } }"></div>
                </div>

                <div class="col-xs-6">
                    <div>
                        <span class="report-widget-label">Top Performing Product Types</span>
                        <a href="#" class="btn btn-primary pull-right" style="width:200px;">
                            <i class="glyphicon glyphicon-zoom-in"></i>&nbsp; Product Type Detail
                        </a>
                    </div>

                    <div id="product-types-pie-chart"
                            style="min-width: 310px; height: 400px; max-width: 600px; margin: 0 auto">
                    </div>

                    <div data-bind="template: { name: 'Report-Profit-Summary-Widget',
                                        data: { ProfitData: ProductTypeByMostProfitable,
                                                CurrencyId: CurrencyId } }"></div>
                </div>
            </div>
        </div> 
         
        <div data-bind="ifnot: ExecutiveSummary.TotalNumberSold > 0">
            <h1 style="margin-top: 100px; margin-bottom:300px; text-align:center; font-weight:700; font-size:4em; color:#CCC;">
                No Data Found With Current Parameters</h1>
        </div>
    </div>
</script>

<!-- Expects to bind to: ProfitData, HeadingLabel, CurrencyId -->
<script id="Report-Profit-Summary-Widget" type="text/html">
    <div data-bind="if: ProfitData.length > 0">
        <table class="table profit-table">
            <thead>
            <tr>
                <th></th>
                <th>Gross Sales</th>
                <th>Cogs</th>
                <th>Profit</th>
                <th># Sold</th>
            </tr>
            </thead>
            <tbody data-bind="foreach: ProfitData">
            <tr>
                <td class="overflow-gracefully">
                    <span data-bind="text: GroupingName, tooltip: { title: GroupingName, placement: 'bottom' }"></span>
                </td>
                <td data-bind="text: ProfitWiseFunctions.FormatCurrency(TotalRevenue, $parent.CurrencyId) "></td>
                <td data-bind="text: ProfitWiseFunctions.FormatCurrency(TotalCogs, $parent.CurrencyId) "></td>
                <td data-bind="text: ProfitWiseFunctions.FormatCurrency(TotalProfit, $parent.CurrencyId)"></td>
                <td data-bind="text: TotalNumberSold"></td>
            </tr>
            </tbody>
        </table>
    </div>
</script>

<script type="text/html" id="Report-Viewer-Context-Summary">
    <div>
        <h2 style="display: inline-block; font-weight: 700;" data-bind="text: Name"></h2>

        <div style="display:inline-block; " data-bind="if: CopyForEditing">
            <div style="margin-left:7px; letter-spacing: 0.1em; font-size:0.9em; color:#888;">(EDITING)                
            </div>
        </div>
    
        <div style="display:inline-block; margin-left:7px; letter-spacing: 0.1em; font-size:0.9em; color:#888;">
            Report Id: <span data-bind="text: ReportId"></span>
        </div>

        <div style="font-size: 1.0em; color: #666;">
            <div style="height: 25px;" data-bind="template:{ name: 'Report-Selection-Preview', data: ReportSelectionCountPreviewModel }"></div>

            <div style="height: 25px;">
                <span>Filtered by</span>
                <span data-bind="template: { name: 'Report-Filter-Summary-Widget', data: ReportFilterSummaryModel }"></span>
            </div>
        </div>
    </div>
</script>

<script type="text/html" id="Report-Viewer-Report-Selector">
    <a href="#" class="btn btn-primary dropdown-toggle report-viewer-top-button"
       data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        Select Report &nbsp;<i class="glyphicon glyphicon-chevron-down"></i>
    </a>

    <ul class="dropdown-menu" style="width: 300px;">
        <!-- ko foreach: SystemDefinedReports -->
        <li>
            <a href="#" data-bind="click: $parent.SelectReportClick">
                <span style="display:inline-block; width:17px;" data-bind="if:CurrentlySelected">
                    <i class="glyphicon glyphicon-ok"></i>
                </span>
                <span data-bind="text: Name"></span>
            </a>
        </li>
        <!-- /ko -->

        <li role="separator" class="divider"></li>

        <!-- ko if: UserDefinedReports().length == 0 -->
        <li><a href="#">(No custom reports defined yet)</a></li>
        <!-- /ko -->

        <!-- ko foreach: UserDefinedReports -->
        <li>
            <a href="#" data-bind="click: $parent.SelectReportClick">
                <span style="display:inline-block; width:17px;" data-bind="if:CurrentlySelected">
                    <i class="glyphicon glyphicon-ok"></i>
                </span>
                <span data-bind="text: Name"></span>
            </a>
        </li>
        <!-- /ko -->
    </ul>
</script>

<!-- Report Viewer and Report Context object definitions -->
<script>
    ProfitWiseWidgets = ProfitWiseWidgets || {};

    ProfitWiseWidgets.ReportGroupingOptionsFactory = function() {
        return @Html.Raw(@PwReportExtensions.AllGroupingToNamedObject().SerializeToJson());
    };

    ProfitWiseWidgets.ReportOrderingOptionsFactory = function() {
        return @Html.Raw(@PwReportExtensions.AllOrderingToNamedObject().SerializeToJson());
    };

    ProfitWiseWidgets.ReportViewerContext = function() {
        var self = this;

        // Reference data
        self.ReportId = ko.observable();
        self.Name = ko.observable();
        self.StartDate = ko.observable();
        self.EndDate = ko.observable();

        self.CopyForEditing = ko.observable(false);
        self.CopyOfSystemReport = ko.observable(false);
        self.IsSystemReport = ko.observable(false);

        self.ReportSelectionCountPreviewModel = new ProfitWiseWidgets.ReportSelectionCountPreviewModel();

        self.ReportFilterSummaryModel = new ProfitWiseWidgets.ReportFilterSummaryModel();
        self.ReportFilterSummaryModel.SummaryClickCallback = function() {
            self.EditFilterClickCallback();
        }

        self.GroupingPopoverModel = new ProfitWiseWidgets.SelectorPopoverWidgetModel();
        self.GroupingPopoverModel.Options(ProfitWiseWidgets.ReportGroupingOptionsFactory());
        self.GroupingPopoverModel.PromptText("Select a method for grouping data");
        self.GroupingPopoverModel.OptionsValue("GroupingId");
        self.GroupingPopoverModel.OptionsText("Description");
        self.GroupingPopoverModel.OkCallback = function() {
            self.Update();
        };
        self.GroupingPopoverModel.PopOverLaunchCallback = function() {
            self.PrepareCopyForEditing();
        };

        self.OrderingPopoverModel = new ProfitWiseWidgets.SelectorPopoverWidgetModel();
        self.OrderingPopoverModel.Options(ProfitWiseWidgets.ReportOrderingOptionsFactory());
        self.OrderingPopoverModel.PromptText("Select a method for ordering data");
        self.OrderingPopoverModel.OptionsValue("OrderingId");
        self.OrderingPopoverModel.OptionsText("Description");
        self.OrderingPopoverModel.OkCallback = function() {
            self.Update();
        };

        self.OrderingPopoverModel.PopOverLaunchCallback = function () {
            self.PrepareCopyForEditing();
        };

        self.ReportLoaded = ko.computed(function() {
            return self.ReportId() != null;
        });

        self.OnlySaveAsAllowed = ko.computed(function() {
            return self.IsSystemReport() || self.CopyOfSystemReport();
        });
        
        self.AfterRenderDateRangePicker = function () {
            ProfitWiseWidgets.CreateDatePicker(".date-ranger-picker", self.PushDateToModelAndUpdate);
        };

        // Expects to receive JavaScript Date objects
        self.PushDatesToDateRangePicker = function (start, end) {
            var dateRangePickerData = $('.date-ranger-picker').data('daterangepicker');

            if (dateRangePickerData) {
                dateRangePickerData.setStartDate(start);
                dateRangePickerData.setEndDate(end);
            }
        };


        self.PushDateToModelAndUpdate = function (startDate, endDate) {
            flow.exec(
                function () {
                    self.PrepareCopyForEditing(this);
                },
                function () {
                    // Taking startDate and endDate from DateRangePicker as moment.js objects
                    // ... we set everything to midnight, local time
                    self.StartDate(ProfitWiseFunctions.MomentStartOfDay(startDate).toDate());
                    self.EndDate(ProfitWiseFunctions.MomentStartOfDay(endDate).toDate());

                    // Push the corrected dates out to DateRangePicker to make it consistent
                    self.PushDatesToDateRangePicker(self.StartDate(), self.EndDate());
                    self.Update();
                }
            );
        };

        self.PrepareCopyForEditing = function(callback) {            
            flow.exec(
                function () {
                    if (self.CopyForEditing()) {
                        if (callback) {
                            callback();
                        }
                        return;
                    }

                    var ajax = new ProfitWiseFunctions.Ajax();
                    ajax.HttpPost("/ReportService/CopyForEditing", { reportId: self.ReportId() }, this);
                },
                function (data) {
                    self.PopulateModel(data);
                    if (callback) {
                        callback();
                    }
                }
            );
        };

        self.PopulateModel = function (data) {
            var current = data.current;
            var original = data.original;

            self.ReportId(current.PwReportId);
            self.Name(current.Name);

            // Store in the local model..
            self.StartDate(current.StartDate.parseDateToStartOfDayLocalTime());
            self.EndDate(current.EndDate.parseDateToStartOfDayLocalTime());

            self.PushDatesToDateRangePicker(self.StartDate(), self.EndDate());
            
            self.CopyForEditing(current.CopyForEditing);
            self.IsSystemReport(current.IsSystemReport);

            self.GroupingPopoverModel.Selection(current.GroupingId);
            self.OrderingPopoverModel.Selection(current.OrderingId);

            self.ReportSelectionCountPreviewModel.ReportId(current.PwReportId);
            self.ReportFilterSummaryModel.ReportId(current.PwReportId);

            self.CopyOfSystemReport(current.CopyForEditing && original.IsSystemReport);
        };

        self.Update = function(callback) {
            flow.exec(
                function () {
                    var ajax = new ProfitWiseFunctions.Ajax();
                    var data = {
                        reportId: self.ReportId(),
                        groupingId: self.GroupingPopoverModel.Selection(),
                        orderingId: self.OrderingPopoverModel.Selection(),
                        startDate: self.StartDate(),
                        endDate: self.EndDate()
                    };

                    ajax.HttpPost("/ReportService/Update", data, this);
                },
                function() {
                    self.TriggerReportDataRefresh(self.ReportId(), this);
                },
                function () {
                    if (callback) {
                        callback();
                    }
                }
            );
        };

        self.LoadReport = function(reportId, callback) {
            flow.exec(
                function () {
                    var ajax = new ProfitWiseFunctions.Ajax();
                    ajax.HttpGet("/ReportService/Report?reportId=" + reportId, this);
                },
                function (data) {
                    self.PopulateModel(data);

                    self.ReportSelectionCountPreviewModel.Refresh(this);
                },
                function () {
                    self.ReportFilterSummaryModel.Refresh(this);
                },
                function () {
                    if (callback) {
                        callback();
                    }
                }
            );
        };

        self.Save = function() {
            flow.exec(
                function() {
                    var ajax = new ProfitWiseFunctions.Ajax();
                    ajax.HttpPost("/ReportService/Save?reportId=" + self.ReportId(), null, this);
                },
                function (data) {
                    self.LoadReport(data.reportId, this);
                }, 
                function() {
                    self.TriggerReportListRefresh(this);
                },
                function() {
                    self.TriggerReportDataRefresh(self.ReportId());
                }
            );
        };

        self.SaveAs = function () {
            flow.exec(
                function() {
                    var url = ProfitWiseConfig.BaseUrl + '/Report/SaveAs?reportId=' + self.ReportId();
                    ProfitWiseShopify.LaunchModal({
                            src: url,
                            title: 'Report Save As...',
                            width: 'small',
                            height: 265,
                        },
                        this);
                },
                function(data) {
                    self.ReportId(data.reportId);
                    self.LoadReport(self.ReportId(), this);
                },
                function() {
                    self.TriggerReportListRefresh(this);
                },
                function () {
                    self.TriggerReportDataRefresh(self.ReportId());
                });
        };
        
        self.Delete = function() {
            flow.exec(
                function () {
                    ShopifyApp.Modal.confirm(
                        "Are you sure you want to delete the Report named '" + self.Name() + "'?", this);
                },
                function (result) {
                    if (!result) {
                        return;
                    }
                    var ajax = new ProfitWiseFunctions.Ajax();
                    ajax.HttpPost("/ReportService/Delete?reportId=" + self.ReportId(), null, this);
                },
                function () {
                    self.TriggerReportListRefresh(this);
                },
                function () {
                    self.LoadReport(OverallProfitabilityReportId, this);
                }
            );
        }

        self.TriggerReportListRefresh = function(callback) { };

        self.EditFilterClickCallback = function() { };

        self.TriggerReportDataRefresh = function() { };

        return self;
    };

    ProfitWiseWidgets.ReportDashboardContext = function() {
        var self = this;

        self.SummaryDataset = ko.observable();

        self.DatasetLoaded = ko.computed(function() {
            return self.SummaryDataset() != null;
        });

        self.LoadDataset = function (reportId, callback) {
            flow.exec(
                function() {
                    var ajax = new ProfitWiseFunctions.Ajax();
                    ajax.HttpPost("/QueryService/Dataset", { reportId: reportId }, this);
                }, 
                function (data) {
                    // Rename to Summary Dataset                    
                    self.SummaryDataset(data.Summary);
                    self.LoadColumnChart('#column-chart', 'Profitability', data.Series, data.Drilldown, data.CurrencyId);
                    
                    if (data.Summary.ExecutiveSummary.TotalNumberSold > 0)
                    {
                        self.LoadPieChart('products-pie-chart', 'Top Products', data.Summary.ProductsByMostProfitable, data.CurrencyId);
                        self.LoadPieChart('vendors-pie-chart', 'Top Vendors', data.Summary.VendorsByMostProfitable, data.CurrencyId);
                        self.LoadPieChart('variants-pie-chart', 'Top Variants', data.Summary.VariantByMostProfitable, data.CurrencyId);
                        self.LoadPieChart('product-types-pie-chart', 'Top Product Types', data.Summary.ProductTypeByMostProfitable, data.CurrencyId);
                    }

                    if (callback) {
                        callback();
                    }
                }
            );
        };

        self.LoadPieChart = function (id, title, keyedDataset, currencyId) {
            var pieChartData =
                AQ(keyedDataset)
                    .select(function (item) {
                        return {
                            name: item.GroupingName,
                            y: item.TotalProfit,
                        }
                    })
                    .toArray();

            Highcharts.chart(id, {
                chart: {
                    plotBackgroundColor: null,
                    plotBorderWidth: null,
                    plotShadow: false,
                    type: 'pie'
                },
                title: {
                    text: ''
                },
                tooltip: {
                    formatter: function() {
                        return this.point.name +
                                ': <strong>' + ProfitWiseFunctions.FormatCurrency(this.y, currencyId) + '</strong>';
                    }
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: true,
                            formatter: function() {
                                return this.point.name.trunc(15) +
                                    ': <strong>' + ProfitWiseFunctions.FormatCurrency(this.y, currencyId) + '</strong>';
                            },
                            style: {
                                color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                            }
                        }
                    }
                },
                series: [{
                    name: 'Profits',
                    colorByPoint: true,
                    data: pieChartData,                    
                }]
            });
        };

        self.LoadColumnChart = function (id, title, seriesData, drilldownData, currencyId) {
            $(id).highcharts({
                chart: { type: 'column', },
                xAxis: { type: 'category' },
                yAxis: { title: { text: 'Total profits' } },
                lang: { drillUpText: '◁ Back' },
                legend: { enabled: true },
                title: { text: '' },

                plotOptions: {
                    series: {
                        borderWidth: 0,
                        dataLabels: {
                            enabled: false,
                            formatter: function() {
                                return ProfitWiseFunctions.FormatCurrency(this.y, currencyId);
                            }
                        }
                    }
                },
                
                tooltip: {
                    formatter: function() {
                        return '<span style="font-size:11px">' + this.series.name + '</span><br>' +
                                '<span style="color:' + this.point.color + '>' + this.point.name + '</span>: ' +
                                ': <strong>' + ProfitWiseFunctions.FormatCurrency(this.y, currencyId) + '</strong>';
                    }
                },

                series: seriesData,
                drilldown: { series: drilldownData, }
            });
        };

        return self;
    };

    ProfitWiseWidgets.ReportViewerModel = function () {
        var self = this;

        // Upper right menu selector for Reports
        self.ReportList = ko.observable([]);

        self.UserDefinedReports = ko.computed(function () {
            return AQ(self.ReportList()).where(function (item) { return item.IsSystemReport == false; }).toArray();
        });

        self.SystemDefinedReports = ko.computed(function () {
            return AQ(self.ReportList()).where(function (item) { return item.IsSystemReport == true; }).toArray();
        });

        self.RefreshReportList = function (callback) {
            flow.exec(
                function () {
                    var ajax = new ProfitWiseFunctions.Ajax();
                    ajax.HttpGet("/ReportService/All", this);
                },
                function (data) {
                    AQ(data).each(
                        function (item) {
                            item.CurrentlySelected =
                                ko.computed(
                                    function () {
                                        if (!self.ReportViewerContext.ReportLoaded()) {
                                            return false;
                                        }
                                        return self.ReportViewerContext.ReportId() == item.PwReportId;
                                    });
                        });

                    self.ReportList(data);
                    if (callback) {
                        callback();
                    }
                });
        };

        // Data for the Top Header
        self.ReportViewerContext = new ProfitWiseWidgets.ReportViewerContext();

        self.ReportViewerContext.TriggerReportListRefresh = function (callback) {
            self.RefreshReportList(callback);
        };
        self.ReportViewerContext.TriggerReportDataRefresh = function (reportId, callback) {
            self.ReportDashboardContext.LoadDataset(reportId, callback);
        };
        self.ReportViewerContext.EditFilterClickCallback = function () {
            self.EditReportClick();
        };

        // Data used to populate the Dashboard
        self.ReportDashboardContext = new ProfitWiseWidgets.ReportDashboardContext();


        // State changes to the Report Selection
        self.SelectReportByReportId = function (id) {
            var report =
                AQ(self.ReportList())
                    .firstOrDefault(function (item) { return item.PwReportId == id; });

            if (report != null) {
                self.SelectReport(report.PwReportId);
            }
        };

        self.SelectReportClick = function (data) {
            var reportId = data.PwReportId;
            self.SelectReport(reportId);
        };

        self.SelectReport = function(reportId) {
            flow.exec(
                function () {
                    self.ReportViewerContext.LoadReport(reportId, this);
                },
                function () {
                    self.ReportDashboardContext.LoadDataset(reportId);
                }
            );
        };

        // Transition to show Report Editor
        self.EditReportClick = function () {
            flow.exec(
                function() {
                    self.ReportViewerContext.PrepareCopyForEditing(this);
                },
                function() {
                    self.EditReportCallback(self.ReportViewerContext.ReportId());
                });
        };

        self.EditReportCallback = function (reportId) { };

        return self;
    };
</script>

