@using ProfitWise.Data.Model
@using Push.Foundation.Web.Json

@Html.Partial("~/Views/SharedTemplates/_SelectorPopoverWidget.cshtml")

<style>
    table#product-types td {
        height: 70px !important;
        font-size: 14px;
        vertical-align: middle !important;
    }
    table#product-types tr td:nth-child(1) {
        width: 10%;
    }
    table#product-types tr td:nth-child(2) {
        width: 45%;
    }
    table#product-types tr td:nth-child(3) {
        width: 45%;
    }
    .report-viewer-top-button {
        width: 130px;
    }
</style>

<script id="Report-Viewer-Top-Level" type="text/html">
    <div id="report-viewer-header" class="fixed-positioning-container">
        <div class="standard-header-sleeve" style="height: 150px; border-bottom: 1px solid #FFF;">

            <!-- This element will track with the scrollbar via JavaScript wiring to onscroll-->
            <div class="standard-header standard-padding top-border-facade" style="overflow: visible; padding-top:20px;">
                <div class="col-xs-6 no-side-padding">
                    <div data-bind="if: ReportViewerContext.ReportLoaded()">
                        <div data-bind="template: { name: 'Report-Viewer-Context-Summary', data: $data.ReportViewerContext }">
                        </div>
                    </div>
                </div>

                <div class="col-xs-6 no-side-padding" style="padding-top:10px; min-width:500px;">
                    <div class="btn-group pull-right" 
                         data-bind="template: { name: 'Report-Viewer-Report-Selector', 
                                                    data: { SystemDefinedReports: $data.SystemDefinedReports,
                                                            UserDefinedReports: $data.UserDefinedReports,
                                                            SelectReportClick: $data.SelectReportClick} }">
                    </div>
                    
                    <div class="pull-right" data-bind="with: ReportViewerContext">
                        <div data-bind="if: OnlySaveAsAllowed">

                            <div class="pull-right" style="margin-right: 7px;">
                                <a href="#" data-bind="click: SaveAs" class="btn btn-primary report-viewer-top-button">
                                    Save As &nbsp;<i class="glyphicon glyphicon-floppy-disk"></i>
                                </a>
                            </div>
                        </div>

                        <div data-bind="ifnot: OnlySaveAsAllowed">
                            <div class="pull-right" style="margin-right: 7px;">
                                <a href="#" data-bind="click: Save" class="btn btn-primary report-viewer-top-button">
                                    Save &nbsp;<i class="glyphicon glyphicon-floppy-disk"></i>
                                </a>
                            </div>
                            <div class="pull-right btn-group" style="margin-right: 7px;">
                                <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">...</button>

                                <ul class="dropdown-menu">
                                    <li><a href="#" data-bind="click: SaveAs">Save As</a></li>
                                    <li><a href="#" data-bind="click: Delete">Delete</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    

                    <div style="clear: both; height: 20px;"></div>                    
                    
                    <div id="report-date-picker" class="pull-right" data-bind="with: ReportViewerContext">
                        <input type="hidden" data-bind="value: StartDate"/>
                        <div data-bind="template: { name: 'Date-Picker-Widget', afterRender: AfterRenderDateRangePicker }"></div>
                    </div>

                    <div class="pull-right">
                        <a href="#" style="margin-right: 7px;"
                           class="btn btn-default report-viewer-top-button" data-bind="click: EditReportClick">
                            Edit Filters &nbsp;<i class="glyphicon glyphicon-filter"></i>
                        </a>
                    </div>
                </div>                   
            </div>
        </div>
    </div>

    <div id="report-viewer-body" class="container page-content-sleeve">
        <!-- Will move/transistion when the filters appear -->
        <div class="page-content" style="margin-top: 150px; padding-top: 30px; overflow: auto;">

            <!-- TODO : allow injection of external template -->
            <div style="position: relative; width: 100%;">
                <img style="width: 100%;" src="@Url.Content("~/Content/images/ProfitabilityMockup.PNG")" />
                <!--<div data-bind="template: { name: 'Body-Template-That-You-Configured'}"></div> -->
            </div>
        </div>
    </div>
</script>

<script type="text/html" id="Report-Viewer-Context-Summary">
    <div class="context-summary-name">
    <h4 style="display: inline-block; font-weight: 700;" data-bind="text: Name"></h4>

    <div style="display:inline-block; " data-bind="if: CopyForEditing">
        <div style="margin-left:7px; letter-spacing: 0.1em; font-size:0.9em; color:#888;">(EDITING)
                
        </div>
    </div>
        
    <div style="display:inline-block; margin-left:7px; letter-spacing: 0.1em; font-size:0.9em; color:#888;">
        Report Id: <span data-bind="text: ReportId"></span>
    </div>

    <div class="context-summary-details"  style="font-size: 1.0em; color: #666;">
        <div style="height: 25px;" data-bind="template:{ name: 'Report-Selection-Preview', data: ReportSelectionCountPreviewModel }"></div>

        <div style="height: 25px;">
            <span>Filtered by</span>
            <span data-bind="template: { name: 'Report-Filter-Summary-Widget', data: ReportFilterSummaryModel }"></span>
        </div>

        <div style="height: 25px;">
            <span>Grouped by </span>
            <span data-bind="template: { name: 'Selector-Popover-Widget', data: GroupingPopoverModel }">
            </span>
            <span>/</span>
            <span>Ordered by </span>
            <span data-bind="template: { name: 'Selector-Popover-Widget', data: OrderingPopoverModel }">
            </span>
        </div>
    </div>
</script>

<script type="text/html" id="Report-Viewer-Report-Selector">
    <a href="#" class="btn btn-primary dropdown-toggle report-viewer-top-button"
        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Select Report &nbsp;<i class="glyphicon glyphicon-chevron-down"></i>
    </a>

    <ul class="dropdown-menu" style="width: 300px;">
        <!-- ko foreach: SystemDefinedReports -->
        <li>
            <a href="#" data-bind="click: $parent.SelectReportClick">
                <span style="display:inline-block; width:17px;" data-bind="if:CurrentlySelected">
                    <i class="glyphicon glyphicon-ok"></i>
                </span>
                <span data-bind="text: Name"></span>
            </a>
        </li>
        <!-- /ko -->

        <li role="separator" class="divider"></li>

        <!-- ko if: UserDefinedReports().length == 0 -->
        <li><a href="#">(No custom reports defined yet)</a></li>
        <!-- /ko -->
        <!-- ko foreach: UserDefinedReports -->
        <li>
            <a href="#" data-bind="click: $parent.SelectReportClick">
                <span style="display:inline-block; width:17px;" data-bind="if:CurrentlySelected">
                    <i class="glyphicon glyphicon-ok"></i>
                </span>
                <span data-bind="text: Name"></span>
            </a>
        </li>
        <!-- /ko -->
    </ul>
</script>

<script>
    ProfitWiseWidgets = ProfitWiseWidgets || {};

    ProfitWiseWidgets.ReportGroupingOptionsFactory = function() {
        return @Html.Raw(@PwReportExtensions.AllGroupingToNamedObject().SerializeToJson());
    };

    ProfitWiseWidgets.ReportOrderingOptionsFactory = function() {
        return @Html.Raw(@PwReportExtensions.AllOrderingToNamedObject().SerializeToJson());
    };

    ProfitWiseWidgets.ReportViewerContext = function() {
        var self = this;

        // Reference data
        self.ReportId = ko.observable();
        self.Name = ko.observable();
        self.StartDate = ko.observable();
        self.EndDate = ko.observable();

        self.CopyForEditing = ko.observable(false);
        self.CopyOfSystemReport = ko.observable(false);
        self.IsSystemReport = ko.observable(false);

        self.ReportSelectionCountPreviewModel = new ProfitWiseWidgets.ReportSelectionCountPreviewModel();
        self.ReportFilterSummaryModel = new ProfitWiseWidgets.ReportFilterSummaryModel();
        self.ReportFilterSummaryModel.SummaryClickCallback = function() {
            self.EditFilterClickCallback();
        }

        self.GroupingPopoverModel = new ProfitWiseWidgets.SelectorPopoverWidgetModel();
        self.GroupingPopoverModel.Options(ProfitWiseWidgets.ReportGroupingOptionsFactory());
        self.GroupingPopoverModel.PromptText("Select a method for grouping data");
        self.GroupingPopoverModel.OptionsValue("GroupingId");
        self.GroupingPopoverModel.OptionsText("Description");
        self.GroupingPopoverModel.OkCallback = function() {
            self.Update();
        };
        self.GroupingPopoverModel.PopOverLaunchCallback = function() {
            self.PrepareCopyForEditing();
        };

        self.OrderingPopoverModel = new ProfitWiseWidgets.SelectorPopoverWidgetModel();
        self.OrderingPopoverModel.Options(ProfitWiseWidgets.ReportOrderingOptionsFactory());
        self.OrderingPopoverModel.PromptText("Select a method for ordering data");
        self.OrderingPopoverModel.OptionsValue("OrderingId");
        self.OrderingPopoverModel.OptionsText("Description");
        self.OrderingPopoverModel.OkCallback = function() {
            self.Update();
        };

        self.OrderingPopoverModel.PopOverLaunchCallback = function () {
            self.PrepareCopyForEditing();
        };


        self.ReportLoaded = ko.computed(function() {
            return self.ReportId() != null;
        });

        self.OnlySaveAsAllowed = ko.computed(function() {
            return self.IsSystemReport() || self.CopyOfSystemReport();
        });
        
        self.AfterRenderDateRangePicker = function () {
            ProfitWiseWidgets.CreateDatePicker(".date-ranger-picker", self.UpdateDate);
        };

        self.PushDatesFromModel = function() {
            var dateRangePickerData = $('.date-ranger-picker').data('daterangepicker');
            if (dateRangePickerData) {
                dateRangePickerData.setStartDate(new Date(self.StartDate().substring(0, 10)));
                dateRangePickerData.setEndDate(new Date(self.EndDate().substring(0, 10)));
            }
        };

        self.UpdateDate = function(startDate, endDate, label) {
            flow.exec(
                function() {
                    self.PrepareCopyForEditing(this);
                },
                function () {
                    self.StartDate(startDate.format("YYYY-MM-DDTHH:mm:ss.SSS[Z]"));
                    self.EndDate(endDate.format("YYYY-MM-DDTHH:mm:ss.SSS[Z]"));

                    //console.log(startDate);
                    //console.log(endDate);

                    self.PushDatesFromModel();
                    self.Update();
                }
            );
        };

        self.PrepareCopyForEditing = function(callback) {            
            flow.exec(
                function () {
                    if (self.CopyForEditing()) {
                        if (callback) {
                            callback();
                        }
                        return;
                    }

                    var ajax = new ProfitWiseFunctions.Ajax();
                    ajax.HttpPost("/ReportService/CopyForEditing", { reportId: self.ReportId() }, this);
                },
                function (data) {
                    self.PopulateModel(data);
                    if (callback) {
                        callback();
                    }
                }
            );
        };

        self.PopulateModel = function (data) {
            self.ReportId(data.PwReportId);
            self.Name(data.Name);
            self.StartDate(data.StartDate);
            self.EndDate(data.EndDate);
            self.PushDatesFromModel();
            
            self.CopyForEditing(data.CopyForEditing);
            self.CopyOfSystemReport(data.CopyOfSystemReport);
            self.IsSystemReport(data.IsSystemReport);

            self.GroupingPopoverModel.Selection(data.GroupingId);
            self.OrderingPopoverModel.Selection(data.OrderingId);

            self.ReportSelectionCountPreviewModel.ReportId(data.PwReportId);
            self.ReportFilterSummaryModel.ReportId(data.PwReportId);            
        };

        self.Update = function(callback) {
            flow.exec(
                function () {
                    var ajax = new ProfitWiseFunctions.Ajax();
                    var data = {
                        reportId: self.ReportId(),
                        groupingId: self.GroupingPopoverModel.Selection(),
                        orderingId: self.OrderingPopoverModel.Selection(),
                        startDate: self.StartDate(),
                        endDate: self.EndDate()
                    };
                    ajax.HttpPost("/ReportService/Update", data, this);
                },
                function () {
                    if (callback) {
                        callback();
                    }
                }
            );
        };

        self.LoadReport = function(reportId, callback) {
            flow.exec(
                function () {
                    var ajax = new ProfitWiseFunctions.Ajax();
                    ajax.HttpGet("/ReportService/Report?reportId=" + reportId, this);
                },
                function (data) {
                    self.PopulateModel(data);

                    self.ReportSelectionCountPreviewModel.Refresh(this);
                },
                function () {
                    self.ReportFilterSummaryModel.Refresh(this);
                },
                function () {
                    if (callback) {
                        callback();
                    }
                }
            );
        };

        self.Save = function() {
            flow.exec(
                function() {
                    var ajax = new ProfitWiseFunctions.Ajax();
                    ajax.HttpPost("/ReportService/Save?reportId=" + self.ReportId(), null, this);
                },
                function (data) {
                    self.LoadReport(data.reportId, this);
                }, 
                function() {
                    self.TriggerReportListRefresh();
                }
            );
        };

        self.SaveAs = function () {
            flow.exec(
                function() {
                    var url = ProfitWiseConfig.BaseUrl + '/Report/SaveAs?reportId=' + self.ReportId();
                    ProfitWiseShopify.LaunchModal({
                            src: url,
                            title: 'Report Save As...',
                            width: 'small',
                            height: 265,
                        },
                        this);
                },
                function(data) {
                    self.ReportId(data.reportId);
                    self.LoadReport(self.ReportId(), this);
                },
                function() {
                    self.TriggerReportListRefresh();
                });
        };
        
        self.Delete = function() {
            flow.exec(
                function () {
                    ShopifyApp.Modal.confirm(
                        "Are you sure you want to delete the Report named '" + self.Name() + "'?", this);
                },
                function (result) {
                    if (!result) {
                        return;
                    }
                    var ajax = new ProfitWiseFunctions.Ajax();
                    ajax.HttpPost("/ReportService/Delete?reportId=" + self.ReportId(), null, this);
                },
                function () {
                    self.TriggerReportListRefresh(this);
                },
                function () {
                    self.LoadReport(OverallProfitabilityReportId, this);
                }
            );
        }

        self.TriggerReportListRefresh = function(callback) {};

        self.EditFilterClickCallback = function() {};

        return self;
    };


    ProfitWiseWidgets.ReportViewerModel = function () {
        var self = this;

        self.ReportList = ko.observable([]);
        self.ReportViewerContext = new ProfitWiseWidgets.ReportViewerContext();
        self.ReportViewerContext.TriggerReportListRefresh = function(callback) {
            self.RefreshReportList(callback);
        };
        self.ReportViewerContext.EditFilterClickCallback = function() {
            self.EditReportClick();
        };
        
        self.UserDefinedReports = ko.computed(function () {
            return AQ(self.ReportList()).where(function (item) { return item.IsSystemReport == false; }).toArray();
        });

        self.SystemDefinedReports = ko.computed(function () {
            return AQ(self.ReportList()).where(function (item) { return item.IsSystemReport == true; }).toArray();
        });

        self.RefreshReportList = function (callback) {
            flow.exec(
                function () {
                    var ajax = new ProfitWiseFunctions.Ajax();
                    ajax.HttpGet("/ReportService/All", this);
                },
                function (data) {
                    AQ(data)
                        .each(
                            function (item) {
                                item.CurrentlySelected =
                                    ko.computed(
                                        function () {
                                            if (!self.ReportViewerContext.ReportLoaded()) {
                                                return false;
                                            }
                                            return self.ReportViewerContext.ReportId()  == item.PwReportId;
                                        });
                            });

                    self.ReportList(data);
                    if (callback) {
                        callback();
                    }
                });
        };

        self.SelectReportByReportId = function (id) {
            var report =
                AQ(self.ReportList())
                    .firstOrDefault(function (item) { return item.PwReportId == id; });

            if (report != null) {
                self.SelectReportClick(report);
            }
        };

        self.SelectReportClick = function (data) {
            var reportId = data.PwReportId;
            self.SelectReport(reportId);
        };

        self.SelectReport = function(reportId) {
            flow.exec(
                function () {
                    self.ReportViewerContext.LoadReport(reportId, this);
                },
                function () {
                    self.SelectReportCallback(reportId);
                }
            );
        };

        // This is where something that renders the Report body is wired in
        self.SelectReportCallback = function (reportId) { };

        self.EditReportClick = function () {
            flow.exec(
                function() {
                    self.ReportViewerContext.PrepareCopyForEditing(this);
                },
                function() {
                    self.EditReportCallback(self.ReportViewerContext.ReportId());
                });
        };

        self.EditReportCallback = function (reportId) { };

        return self;
    };
</script>

