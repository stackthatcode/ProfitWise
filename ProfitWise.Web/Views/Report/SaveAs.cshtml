@using ProfitWise.Web.Attributes
@using Push.Foundation.Utilities.Json
@using Push.Foundation.Web.Json
@model ProfitWise.Web.Models.SaveAsModel
@{
    Context.PullCommonContext().PageTitle = "Report Save As";
    Layout = "~/Views/Shared/_AuthenticatedPopupLayout.cshtml";
}

<script type="text/html" id="Main-Template">
    <form onsubmit="return false;">
        <div class="row-fluid" style="overflow:auto;">
            <div class="col-xs-3 no-side-padding" style="padding-top:8px;">
                <span>Report Name</span>
            </div>
            <div class="col-xs-9">
                <input id="report-name" style="width:100%;" type="text" class="form-control"
                       maxlength="100" data-bind="value: Name, event: { keyup: InvokeKeyCallback }" />
            </div>
        </div>

        <div class="row-fluid" style="overflow:auto;">
            <div class="col-xs-3">
                
            </div>
            <div class="col-xs-9" style="padding-top:10px; padding-bottom: 10px;">
                <div class="checkbox" data-bind="if: ShowDeleteOriginal">
                    <label>
                        <input type="checkbox" data-bind="checked: DeleteOriginal">
                        <span style="font-weight:700;">Delete the original Report</span>
                    </label>
                </div>
            </div>
        </div>
        <div class="row-fluid" style="overflow:auto;">
            <div class="col-xs-12" style="height:75px;" data-bind="if: ValidationMessage">
                <div class="alert alert-info">
                    <strong>Failed:</strong> <span data-bind="text:ValidationMessage"></span>
                </div>
            </div>
        </div>
        <div class="row-fluid">
            <div class="col-xs-12" style="text-align: right;">
                <a href="#" class="btn btn-default" style="width:125px;" data-bind="click: CancelButtonClick">
                    <i class="glyphicon glyphicon-remove"></i>&nbsp; Cancel
                </a>

                <a href="#" class="btn btn-primary" style="width:125px;" data-bind="click: SaveButtonClick">
                    <i class="glyphicon glyphicon-ok"></i>&nbsp; Save
                </a>
            </div>
        </div>

        <div style="height:20px;"></div>
</form>
</script>

<div data-bind="template: { name: 'Main-Template', afterRender: function() { $('input#report-name').focus(); } }">
</div>

<script>
    var modelData = @Html.Raw(Model.SerializeToJson());
    
    $(document)
        .ready(function () {
            var ProfitWise = ProfitWise || {};

            ProfitWise.ReportSaveAsModel = function() {
                var self = this;

                self.ReportId = ko.observable();
                self.Name = ko.observable();
                self.DeleteOriginal = ko.observable(false);
                self.ValidationMessage = ko.observable();

                self.CopyForEditing = ko.observable(false);
                self.IsSystemReport = ko.observable(false);
                
                self.CopyOfSystemReport = ko.observable(false);

                // Need to add "IsCopyOfOriginal" - or actually Original Report object
                self.ShowDeleteOriginal = ko.computed(
                    function() {
                        return !self.IsSystemReport() && !self.CopyOfSystemReport();
                    }
                );

                self.SaveButtonClick = function() {
                    flow.exec(
                        function() {
                            var data = {
                                reportId: self.ReportId(),
                                deleteOriginal: self.DeleteOriginal(),
                                name: self.Name(),
                            };

                            var settings = new ProfitWiseFunctions.AjaxSettings(true);
                            var ajax = new ProfitWiseFunctions.Ajax(settings);
                            
                            ajax.HttpPost("/ReportService/SaveAs", data, this);
                        }, 
                        function(response) {
                            if (!response.success) {
                                self.ValidationMessage(response.message);
                            } else {
                                self.ValidationMessage();
                                ShopifyApp.Modal.close({ result: true, reportId: response.reportId });
                            }
                        }
                    );
                };
                
                self.CancelButtonClick = function() {
                    ShopifyApp.Modal.close({ result: false });
                };

                self.InvokeKeyCallback = function (model, event) {
                    if (event.keyCode == 27) {
                        ShopifyApp.Modal.close({ result: false });
                        return false;
                    }
                    if (event.keyCode == 13) {
                        self.SaveButtonClick();
                        return false;
                    } else {
                        return true;
                    }
                };
            };

            var model = new ProfitWise.ReportSaveAsModel();
            model.ReportId(modelData.Current.PwReportId);
            model.Name(modelData.Current.Name);
            model.IsSystemReport(modelData.Current.IsSystemReport);

            model.CopyOfSystemReport(
                modelData.Current.CopyForEditing && modelData.Original.IsSystemReport);
            
            // Load Product data into the model
            ko.applyBindings(model);
        });
</script>
   