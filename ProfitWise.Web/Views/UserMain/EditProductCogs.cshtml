@using Push.Foundation.Web.Json
@model ProfitWise.Web.Models.EditProductCogsModel

@{
    ViewBag.CommonContext.PageTitle = "Edit Product Cost of Goods";
}


<style>
    table.table td {
        height: 70px !important;
        font-size: 14px;
        vertical-align: middle !important;
    }

    table.table th {
        font-size: 14px !important;
        font-weight: 700;
        color: #777;
        height: 60px;
    }

    #product-cogs tr td:nth-child(1), #heading tr th:nth-child(1) {
        width: 15%;
    }

    #product-cogs tr td:nth-child(2), #heading tr th:nth-child(2) {
        width: 25%;
    }

    #product-cogs tr td:nth-child(3), #heading tr th:nth-child(3) {
        width: 14%;
    }

    #product-cogs tr td:nth-child(4), #heading tr th:nth-child(4) {
        width: 13%;
        text-align: center;
    }

    #product-cogs tr td:nth-child(5), #heading tr th:nth-child(5) {
        width: 13%;
        text-align: center;
    }

    #product-cogs tr td:nth-child(6), #heading tr th:nth-child(6) {
        width: 10%;
        text-align: center;
    }

    #product-cogs tr td:nth-child(7), #heading tr th:nth-child(7) {
        width: 10%;
        text-align: center;
    }

    input[type='text'] {
        width: 100px;
    }

</style>

<!-- KnockoutJS Templates -->
@Html.Partial("_PagingWidget")
@Html.Partial("_ProductFilterWidget")
@Html.Partial("_MoneyRangeWidget")

<script type="text/html" id="Page-Header">
    <div id="fixed-positioning-container">
        <div id="top-header-sleeve" style="height: 210px;">

            <!-- This element will track with the scrollbar via JavaScript wiring to onscroll-->
            <div id="top-header">

                <!-- Filtering and Paging -->
                <div class="row" style="padding-left: 25px; padding-right: 25px;">
                    <!-- Filtering Widget -->
                    <div class="col-lg-6" style="padding-top: 20px;">
                        <div class="pull-left;"
                             data-bind="template: { name: 'Product-Filter-Widget', data: $root.FilterModel }">
                        </div>
                    </div>

                    <!-- Paging Widget -->
                    <div class="col-lg-6">
                        <div style="height: 20px;" class="visible-lg"></div>
                        <div data-bind="visible: $root.CurrentGrid().length > 0">
                            <div style="min-width: 500px;" data-bind="template: { name: 'Paging-Widget', data: $root.PagingModel }">
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Table Headings - note: measured table rendering height is 61px, top border offset is 20px; -->
                <div class="header-horz-padding" style="position: absolute; top: 129px;"
                     data-bind="visible: $root.CurrentGrid().length > 0">
                    <table class="table" id="heading" style="margin-bottom: 0px;">
                        <thead>
                        <tr>
                            <th class="order-by-column"
                                data-bind="click: function() { SortByClick(0) }">
                                Vendor

                                <span data-bind="visible: SortByColumnIndex() == 0">
                                    <span data-bind="template: 'Sorting-Arrows-Active'"></span>
                                </span>
                                <span data-bind="visible: SortByColumnIndex() != 0">                                    
                                </span>
                            </th>

                            <th class="order-by-column" data-bind="click: function() { SortByClick(1); }">
                                Product

                                <span data-bind="visible: SortByColumnIndex() == 1">
                                    <span data-bind="template: 'Sorting-Arrows-Active'"></span>
                                </span>
                                <span data-bind="visible: SortByColumnIndex() != 1">
                                </span>
                            </th>

                            <th>Inventory</th>
                            <th>Price</th>
                            <th>CoGS</th>

                            <th style="text-align: center;"><a href="#" data-bind="click: $root.StockedDirectlyPickListPopup">Stocked Directly</a></th>
                            <th style="text-align: center;"><a href="#" data-bind="click: $root.ExcludePickListPopup">Exclude</a></th>
                        </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
</script>

<script type="text/html" id="Sorting-Arrows-Active">
    <span data-bind="if: $root.SortByDirectionDown">
        <i class="glyphicon glyphicon-triangle-bottom"></i>
    </span>
    <span data-bind="ifnot: $root.SortByDirectionDown">
        <i class="glyphicon glyphicon-triangle-top"></i>
    </span>
</script>

<script type="text/html" id="Main-Template">
    <div data-bind="template: { name: 'Page-Header', data: $data }"></div>

    <div class="container" style="margin: 0; width: 100%; padding-left: 20px; padding-right: 20px;">
        <div style="position: relative; min-width: 900px; margin-top: 209px; background-color: #FFF; padding-left: 25px; padding-right: 25px;">

            <!-- No Products Found matching XYZ -->
            <div id="no-products-found" style="width: 100%;"
                 data-bind="visible: $root.NoProductsFound() && $root.CurrentGrid().length == 0">
                <div style="text-align: center; padding-top: 20px; padding-bottom: 100px;">
                    <i style="font-size: 6.0em; color: #CCC;" class="glyphicon glyphicon-tag"></i>
                    <h3 style="color: #555; font-weight: 300;">Could not find any products</h3>
                    <span style="color: #AAA;">Try changing the filters or search term</span>
                </div>
            </div>

            <!-- Search Results -->
            <table id="product-cogs" class="table" style="width: 100%; height: 100%; margin: 0;">
                <tbody data-bind="foreach: $root.CurrentGrid">
                <tr>
                    <td class="overflow-gracefully">
                        <span data-bind="if: Vendor">
                            <span data-bind="text: Vendor"></span>
                        </span>
                        <span data-bind="ifnot: Vendor">
                            (No Vendor)
                        </span>
                    </td>
                    <td class="overflow-gracefully"><a href="CoGSProduct.html" data-bind="text: ProductTitle"></a></td>
                    <td><span data-bind="text: InventoryCount"></span> in stock<br/>
                        (<span data-bind="text: VariantCount"></span> variants)</td>

                    <td data-bind="template: { name: 'Money-Range-Widget-Vertical', data: Price }">
                    </td>

                    <td>
                        <a href="#" data-bind="click: $root.BulkEditPopUp">
                            <span data-bind="template: { name: 'Money-Range-Widget-Vertical', data: Cogs }">
                            </span>
                        </a>
                    </td>
                    <td>
                        <div data-bind="if: StockedDirectlyCount == VariantCount || StockedDirectlyCount == 0">
                            <input type="checkbox" data-bind="click: $root.StockedDirectlyCheckboxClick, checked: $root.StockedDirectlyIsChecked($data)"/>
                        </div>

                        <div data-bind="if: StockedDirectlyCount > 0 && StockedDirectlyCount < VariantCount">
                            <a href="#"
                               data-bind="click: $root.StockedDirectlyGridLinkClick">
                                <span data-bind="text: StockedDirectlyCount"></span> of
                                <span data-bind="text: VariantCount"></span>
                            </a>
                        </div>
                    </td>

                    <td>
                        <div data-bind="if: ExcludedCount == VariantCount || ExcludedCount == 0">
                            <input type="checkbox" data-bind="click: $root.ExcludedCheckboxClick, checked: $root.ExcludedIsChecked($data)"/>
                        </div>

                        <div data-bind="if: ExcludedCount > 0 && ExcludedCount < VariantCount">
                            <a href="#"
                               data-bind="click: $root.ExcludedGridLinkClick">
                                <span data-bind="text: ExcludedCount"></span> of
                                <span data-bind="text: VariantCount"></span>
                            </a>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

</script>

<!-- KnockoutJS Root View --><!-- data: $root.EndlessGlider, -->
<div data-bind="template: { name: 'Main-Template' }">
</div>



<!-- KnockoutJS Model -->
<script>
    var productTypes = @Html.Raw(Model.ProductTypes.SerializeToJson());
    var productVendors = @Html.Raw(Model.Vendors.SerializeToJson());

    var ProfitWise = ProfitWise || {};

    ProfitWise.EditCogsModel = function () {
        var self = this;

        self.PickListId = ko.observable();
        self.CurrentGrid = ko.observableArray();
        self.NoProductsFound = ko.observable(false);

        self.PagingModel = new ProfitWiseWidgets.PagingModel();

        self.FilterModel = new ProfitWiseWidgets.ProductFilterModel(productTypes, productVendors);
        self.FilterModel.RegisterCallbackFunction(function() { self.SearchForProducts(); });


        // *** Sorting functionality *** //
        self.SortByColumnIndex = ko.observable(0);
        self.SortByDirectionDown = ko.observable(true);

        self.SortByClick = function(index) {
            if (index == self.SortByColumnIndex()) {
                self.SortByDirectionDown(!self.SortByDirectionDown());
            } else {
                self.SortByDirectionDown(true);
            }
            self.SortByColumnIndex(index);
            self.LoadDataForCurrentPage();
        }

        
        // *** Launch Bulk Edit Popup *** //
        self.BulkEditPopUp = function (model) {
            var url =
                ProfitWiseConfig.BaseUrl +
                    '/UserMain/BulkEditCogs?masterProductId=' + masterProductId;

            ProfitWiseShopify.LaunchModal({
                src: url,
                title: 'Bulk Edit all Variant CoGS',
                width: 'small',
                height: 380,
            }, self.LoadDataForCurrentPage);
        }

        
        // *** Stocked Directly interactivity *** //        
        self.StockedDirectlyPickListPopup = function () {
            var url =
                ProfitWiseConfig.BaseUrl +
                    '/UserMain/StockedPicklistPopup?pickListId=' + self.PickListId();
    
            ProfitWiseShopify.LaunchModal({
                src: url,
                title: 'Set Stocked Directly for all Products in Search',
                width: 'small',
                height: 300,
            }, self.LoadDataForCurrentPage);
        };
        
        self.StockedDirectlyIsChecked = function (data) {
            return data.StockedDirectlyCount == data.VariantCount;
        };

        self.StockedDirectlyCheckboxClick = function (model) {
            var settings = new ProfitWiseFunctions.AjaxSettings();
            var ajax = new ProfitWiseFunctions.Ajax(settings);
            var data = {
                masterProductId: model.Id,
                value: !self.StockedDirectlyIsChecked(model),
            };

            ajax.HttpPost("/Cogs/StockedDirectlyById", data, self.LoadDataForCurrentPage);
        };

        self.StockedDirectlyGridLinkClick = function (model) {
            ProfitWiseShopify.LaunchStockedDirectlyVariantsPopup(model.Id, function () {
                alert("ok, let's do something!!!");
            });
        };


        // ** Excluded interactivity *** //        
        self.ExcludePickListPopup = function () {
            var url = 
                ProfitWiseConfig.BaseUrl + 
                    '/UserMain/ExcludedPickListPopup?pickListId=' + self.PickListId();
            
            ProfitWiseShopify.LaunchModal({
                src: url,
                title: 'Set Exclude/Include for all Products in Search',
                width: 'small',
                height: 350,
            }, self.LoadDataForCurrentPage);
        };

        self.ExcludedIsChecked = function(data) {
            return data.ExcludedCount == data.VariantCount;
        };
        
        self.ExcludedCheckboxClick = function (model) {
            var settings = new ProfitWiseFunctions.AjaxSettings();
            var ajax = new ProfitWiseFunctions.Ajax(settings);
            var data = {
                masterProductId: model.Id,
                value: !self.ExcludedIsChecked(model),
            };

            ajax.HttpPost("/Cogs/ExcludeById", data, self.LoadDataForCurrentPage);
        };

        self.ExcludedGridLinkClick = function (model) {
            ProfitWiseShopify.LaunchExcludedProductVariantPopup(model.Id, function () {
                alert("ok, let's do something for excluded!!!");
            });
        };




        // *** Search for Products *** //
        self.SearchForProducts = function () {            
            var filters = [];
            ko.utils.arrayForEach(
                self.FilterModel.SelectedFiltersForSearch(),
                function(item) {
                    filters.push({ 
                        Type: item.Type(),
                        Value: item.Value(),
                    });
                });

            var search = {
                Text: self.FilterModel.SearchText(),
                Filters: filters,
            };
            
            var ajax = new ProfitWiseFunctions.Ajax();
            ajax.HttpPost(
                "/Cogs/Search",
                search,
                function(data) {
                    self.PickListId(data.PickListId);
                    self.PagingModel.PageNumber(1);
                    self.LoadDataForCurrentPage();
                });
        };

        self.LoadDataForCurrentPage = function () {
            var resultsPaging = {
                PickListId: self.PickListId(),
                PageNumber: self.PagingModel.PageNumber(),
                PageSize: self.PagingModel.PageSize(),
                SortByColumn: self.SortByColumnIndex(),
                SortByDirectionDown: self.SortByDirectionDown(),
            };
 
            var ajax = new ProfitWiseFunctions.Ajax();
            ajax.HttpPost(
                "/Cogs/RetrieveResults", 
                resultsPaging,
                function (data) {
                    self.CurrentGrid.removeAll();

                    if (data.products.length == 0) {
                        self.NoProductsFound(true);
                    } else {
                        self.NoProductsFound(false);
                        self.CurrentGrid(data.products);
                        self.PagingModel.RecordCount(data.totalRecords);
                    }
                });
        };
        
        self.PagingModel.SubscribeCallbackFunction(self.LoadDataForCurrentPage);

        return self;
    };


    $(document)
        .ready(function () {
            ProfitWiseFunctions.TableHeaderWidthInit("table#product-cogs tbody tr td", "table#heading thead tr th");
            ProfitWiseFunctions.FixedHeaderScrollingInit("#top-header");
            ProfitWiseFunctions.PopOverAutoCloseInit();

            var model = new ProfitWise.EditCogsModel();
            model.SearchForProducts();
            ko.applyBindings(model);
        });
</script>


<script>
/*
flow.exec(
            function () {
                $("#spinner-layer").show();
                setTimeout(this, 1500);
            },
            function() {
                $("#spinner-layer").hide();
                callback(fakeDataFunction());
            });
            */

</script>



