@Html.Partial("~/Views/UserMain/_FilterPagingWidget.cshtml")

<script type="text/html" id="Report-Editor-Header-Product-Type">
    <div class="row-fluid">
        <div class="col-xs-8 no-side-padding">
            <div data-bind="template: { name: 'Filter-Paging-Widget', data: $data.FilterModel }"></div>
        </div>
        <div class="col-xs-4"></div>
    </div>

    <div class="row-fluid">
        <div class="col-xs-8 no-side-padding" 
             style="border-top: 1px dashed #CCC;"
             data-bind="if: $data.PageOfProductTypes().length">
            
            <!-- Move the Select all thingy outside, here -->
            <div data-bind="ifnot: SelectionModel.AllAreSelected">
                <a href="#" style="position:absolute; top:-40px; font-weight: 700;"
                    data-bind="click: SelectionModel.SelectAll">Select All</a>
            </div>
            <div data-bind="if: SelectionModel.AllAreSelected">
                <a href="#" style="position:absolute; top:-40px; font-weight: 700;"
                    data-bind="click: SelectionModel.DeselectAll">Deselect All</a>
            </div>
        </div>
        <div class="col-xs-1"></div>
        <div class="col-xs-3 no-side-padding" style="top:-120px; height: 250px;">
            <div style="padding:20px;">

                <p style="font-weight:700; color:#666; font-size:1.2em;">Select the Product Types to include in your Report</p>
                <div style="height:65px;">
                    <p style="font-size:0.95em;">Displayed results will only include data from selected Product Types.</p>
                </div>
                <p><a href="#" data-bind="click: GotoNextCallback" class="btn btn-default">Next &gt;&gt;</a></p>
            </div>
        </div>
    </div>
</script>

<script type="text/html" id="Report-Editor-Body-Product-Type">
    <div class="row-fluid">
        <div class="col-xs-8 reduced-padding">
            
            <div data-bind="if: PageOfProductTypes().length == 0">
                <div data-bind="template: { name: 'Report-Editor-Empty-Results', data: { ItemDescription: 'Product Types' } }"></div>               
            </div>

            <table id="product-types" class="table" style="width: 100%; height: 100%; margin: 0;">
                <tbody data-bind="foreach: PageOfProductTypes">
                <tr style="border-top: 0;">
                    <td>
                        <input class="form-control"
                                type="checkbox" 
                                style="height: 15px; width: 15px;" 
                                data-bind="checked: $data.IsChecked, click: $parent.CheckboxClick"  />
                    </td>

                    <td data-bind="text: $data.CorrectedProductType"></td>
                    <td>(<span data-bind="text: $data.Count"></span> Products)</td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="col-xs-4">
        </div>
    </div>
</script>

<script>
    ProfitWiseWidgets.ReportEditorVendorModel = function() {
        var self = this;
        return self;
    };

    ProfitWiseWidgets.SelectionModel = function() {
        var self = this;
        self.AllSelected = ko.observable(true);
        self.MarkedItems = ko.observableArray();
        self.Callback = function() {
        };

        self.IsSelected = function (item) {
            console.log(item);
            var isMarked = AQ(self.MarkedItems()).contains(item);
            return self.AllSelected() ? !isMarked : isMarked;
        };

        self.MarkItem = function (item) {
            self.MarkedItems.push(item);
            self.Callback();

            // Move this to parent
            //if (self.MarkedItems().length == self.ProductTypes().length && self.AllSelected() == false) {
            //    self.SelectAll();
            //}
        };

        self.UnmarkItem = function (item) {
            self.MarkedItems.remove(function (n) {
                return n == item;
            });
            self.Callback();
        };

        self.AllAreSelected = ko.computed(function () {
            return self.MarkedItems().length == 0 && self.AllSelected();
        });

        self.SelectAll = function () {
            self.AllSelected(true);
            self.MarkedItems.removeAll();
            self.Callback();
        }

        self.DeselectAll = function () {
            self.AllSelected(false);
            self.MarkedItems.removeAll();
            self.Callback();
        }

        // Need to pass item.ProductType to this
        self.ToggleSelect = function (item) {
            var currentlySelected = self.IsSelected(item);

            if (self.AllSelected() && currentlySelected) {
                self.MarkItem(item);
            }
            if (!self.AllSelected() && !currentlySelected) {
                self.MarkItem(item);
            }
            if (self.AllSelected() && !currentlySelected) {
                self.UnmarkItem(item);
            }
            if (!self.AllSelected() && currentlySelected) {
                self.UnmarkItem(item);
            }
        };
        return self;
    };

    ProfitWiseWidgets.ReportProductTypeModel = function (parent) {
        var self = this;
        self.Parent = parent;
        self.ReportId = ko.observable();

        // Data
        self.ProductTypes = ko.observableArray();
        self.PageOfProductTypes = ko.observableArray();

        // Selections
        self.SelectionModel = new ProfitWiseWidgets.SelectionModel();
        self.SelectionModel.Callback = function() {
            self.ApplyFiltersAndPaging();
        }

        // Paging and Filtering model
        self.FilterModel = new ProfitWiseWidgets.FilterPagingWidgetModel();
        self.FilterModel.PlaceHolderText("Search for Product Types...");
        self.FilterModel.RegisterRefreshCallback(function () {
            self.ApplyFiltersAndPaging();
        });

        self.FilterModel.SetPageSize(5);

        self.CheckboxClick = function(data) {
            self.SelectionModel.ToggleSelect(data.ProductType);
            return true;
        };

        self.AddObservables = function(data) {
            AQ(data)
                .each(function (item) {
                    item.IsChecked = ko.computed(function () {
                        return self.SelectionModel.IsSelected(item.ProductType);
                    });

                    item.CorrectedProductType = ko.computed(function() {
                        return item.ProductType == "" ? "(No Product Type)" : item.ProductType;
                    });
                });
        };

        self.Refresh = function (reportId) {
            self.ReportId(reportId);
            self.FilterModel.SetPageNumber(1);
            var ajax = new ProfitWiseFunctions.Ajax();
            
            flow.exec(
                function () {
                    ajax.HttpGet("/ReportService/ProductTypes", this);
                },
                function (data) {
                    self.AddObservables(data);
                    self.ProductTypes(data);
                    ajax.HttpGet("/ReportService/SelectedProductTypes?reportId=" + self.ReportId(), this);
                },
                function (data) {
                    self.SelectionModel.AllSelected(data.AllProductTypes);
                    self.SelectionModel.MarkedItems(data.MarkedProductTypes);
                    self.ApplyFiltersAndPaging();
                }
            );
        }

        self.Save = function() {
            flow.exec(
                function () {
                    var ajax = new ProfitWiseFunctions.Ajax();
                    var data = {
                        reportId: self.ReportId(),
                        selectAll: self.SelectionModel.AllSelected(),
                        markedProductTypes: self.SelectionModel.MarkedItems(),
                    };
                    ajax.HttpPost("/ReportService/SelectedProductTypes", data, this);
                },
                function(results) {
                });
        };

        self.ApplyFiltersAndPaging = function () {
            var searchText = self.FilterModel.SearchText() || "";
            var isShowAllSelected = self.FilterModel.IsShowAllSelected();

            var filteredProductTypes = self.ProductTypes();
            if (searchText.trim() != "") {
                filteredProductTypes = 
                    AQ(filteredProductTypes)
                    .where(function (item) {
                        return ProfitWiseFunctions
                            .CaseInsensitiveContains(item.ProductType, searchText);
                    })
                    .toArray();
            }

            if (!isShowAllSelected) {
                filteredProductTypes =
                    AQ(filteredProductTypes)
                    .where(function (item) { return item.IsChecked() })
                    .toArray();
            }

            self.FilterModel.SetRecordCount(filteredProductTypes.length);

            var pageNumber = self.FilterModel.GetPageNumber();
            var skip = (pageNumber - 1) * self.FilterModel.GetPageSize();
            var take = self.FilterModel.GetPageSize();

            self.PageOfProductTypes(
                AQ(filteredProductTypes)
                .skip(skip)
                .take(take)
                .where(function(n) { return n != null })
                .toArray());
        };

        self.GotoNextCallback = function () { };
        
        return self;
    };
</script>