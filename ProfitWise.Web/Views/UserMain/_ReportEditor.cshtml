@using ProfitWise.Data.Model
@Html.Partial("~/Views/UserMain/_FilterPagingWidget.cshtml")
@Html.Partial("~/Views/UserMain/_SelectionModel.cshtml")
@Html.Partial("~/Views/UserMain/_ReportEditorCommonTemplates.cshtml")
@Html.Partial("~/Views/UserMain/_ReportEditorProductType.cshtml")
@Html.Partial("~/Views/UserMain/_ReportEditorVendor.cshtml")
@Html.Partial("~/Views/UserMain/_ReportEditorMasterProduct.cshtml")
@Html.Partial("~/Views/UserMain/_ReportEditorSku.cshtml")


<style>
    table#product-types td {
        height: 70px !important;
        font-size: 14px;
        vertical-align: middle !important;
    }

    table#product-types tr td:nth-child(1) {
        width: 10%;
    }
    table#product-types tr td:nth-child(2) {
        width: 45%;
    }
    table#product-types tr td:nth-child(3) {
        width: 45%;
    }
</style>



<!-- Requires a ReportEditorWidget passed in KO template "data" parameter -->
<script type="text/html" id="Report-Editor-Header">
    <!-- Spacer - 15px -->
    <div class="vert-spacer" style="height: 15px;"></div>

    <!-- Nav tabs - 43px -->
    <div class="row-fluid" style="height: 43px;">
        <div class="col-xs-7 no-side-padding">
            <div style="overflow:auto; height:40px;">
                <ul class="nav nav-tabs" role="tablist" style="position: absolute; width: 100%;">
                    <li role="presentation" class="active">
                        <a href="#report-filter-product-type"
                           data-bind="click: ProductTypeClick"
                           aria-controls="home" role="tab" data-toggle="tab">Product Types</a>
                    </li>
                    <li role="presentation">
                        <a href="#report-filter-vendor"
                           data-bind="click: VendorClick"
                           aria-controls="profile" role="tab" data-toggle="tab">Vendors</a>
                    </li>
                    <li role="presentation">
                        <a href="#report-filter-product"
                           data-bind="click: MasterProductClick"
                           aria-controls="messages" role="tab" data-toggle="tab">Products</a>
                    </li>
                    <li role="presentation">
                        <a href="#report-filter-sku"
                           data-bind="click: SkuClick"
                           aria-controls="settings" role="tab" data-toggle="tab">SKUs</a>
                    </li>
                </ul>
            </div>
            
            <!-- Tab panes -->
            <div class="tab-content" style="clear: both;">
                <!-- Height - 120px -->
                <div id="report-filter-product-type" role="tabpanel" class="tab-pane active reduced-padding"
                     data-bind="template: { name: 'Report-Editor-Header-Product-Type', data: ReportProductTypeModel }">
                </div>
                <div id="report-filter-vendor" role="tabpanel" class="tab-pane reduced-padding"
                     data-bind="template: { name: 'Report-Editor-Header-Vendor', data: ReportVendorModel }">
                </div>
                <div id="report-filter-product" role="tabpanel" class="tab-pane reduced-padding"
                     data-bind="template: { name: 'Report-Editor-Header-Master-Product', data: ReportMasterProductModel }">
                </div>
                <div id="report-filter-sku" role="tabpanel" class="tab-pane reduced-padding"
                     data-bind="template: { name: 'Report-Editor-Header-Sku', data: ReportSkuModel }">
                </div>
            </div>
        </div>
        
        <div class="col-xs-5 no-side-padding" style="background-color:white; height: 300px; padding-left:45px; ">
            <div style="font-size:1.10em; height:40px; padding-top:8px; font-weight: 700;">Select Filters to add to your Report</div>

            <p>This Report includes <span style="font-weight: 700; color:#888;">1,485 Products</span>.</p>
            
            <p>Select Filters to add to Report, then hit "Ok" when you're done.</p>
            
            <div style="margin-bottom:20px;">
                <a href="#" class="btn btn-primary btn-sm" style="width: 95px;" data-bind="click: CancelButtonClick">
                    Cancel &nbsp;<i class="glyphicon glyphicon-remove"></i>
                </a>

                <a href="#" class="btn btn-primary btn-sm" style="width: 95px;" data-bind="click: OkButtonClick">
                    Ok &nbsp;<i class="glyphicon glyphicon-ok"></i>
                </a>
            </div>
            
            <div style="overflow-y:auto; height:300px;">
                <div style="margin-bottom:5px; font-size:0.8em; font-weight:700;">Product Type Filters:</div>
                <div data-bind="foreach: FiltersGrid">
                    <div class="filter-tag-container"
                         style="display:inline-block; margin-bottom:5px;"
                         data-bind="tooltip: { title: $data.Description, placement: 'bottom' }">

                        <div class="filter-description">
                            <span data-bind="text: $data.Title"></span>
                        </div>

                        <!-- Add a delete method here... -->
                        <a class="filter-remove" href="#" data-bind="click: $parent.RemoveFilter">
                            &nbsp;
                            <i class="glyphicon glyphicon-remove"></i>
                        </a>
                    </div>
                </div>

                <div style="margin-top:10px; margin-bottom:5px; font-size:0.8em; font-weight:700;">Vendor Filters:</div>
                <div data-bind="foreach: FiltersGrid">
                    <div class="filter-tag-container"
                         style="display:inline-block; margin-bottom:5px;"
                         data-bind="tooltip: { title: $data.Description, placement: 'bottom' }">

                        <div class="filter-description">
                            <span data-bind="text: $data.Title"></span>
                        </div>

                        <!-- Add a delete method here... -->
                        <a class="filter-remove" href="#" data-bind="click: $parent.RemoveFilter">
                            &nbsp;
                            <i class="glyphicon glyphicon-remove"></i>
                        </a>
                    </div>
                </div>

                <div style="margin-top:10px; margin-bottom:5px; font-size:0.8em; font-weight:700;">Product Filters:</div>
                <div data-bind="foreach: FiltersGrid">
                    <div class="filter-tag-container"
                         style="display:inline-block; margin-bottom:5px;"
                         data-bind="tooltip: { title: $data.Description, placement: 'bottom' }">

                        <div class="filter-description">
                            <span data-bind="text: $data.Title"></span>
                        </div>

                        <!-- Add a delete method here... -->
                        <a class="filter-remove" href="#" data-bind="click: $parent.RemoveFilter">
                            &nbsp;
                            <i class="glyphicon glyphicon-remove"></i>
                        </a>
                    </div>
                </div>
            </div>

        </div>
    </div>  
</script>


<!-- Requires a ReportEditorWidget passed in KO template "data" parameter -->
<script type="text/html" id="Report-Editor-Body">
    <div data-bind="if: SelectedFilterModel() == ReportProductTypeModel">
        <div data-bind="template: { name: 'Report-Editor-Body-Product-Type', data: ReportProductTypeModel }"></div>
    </div>

    <div data-bind="if: SelectedFilterModel() == ReportVendorModel">
        <div data-bind="template: { name: 'Report-Editor-Body-Vendor', data: ReportVendorModel }"></div>
    </div>

    <div data-bind="if: SelectedFilterModel() == ReportMasterProductModel">
        <div data-bind="template: { name: 'Report-Editor-Body-Master-Product', data: ReportMasterProductModel }"></div>
    </div>

    <div data-bind="if: SelectedFilterModel() == ReportSkuModel">
        <div data-bind="template: { name: 'Report-Editor-Body-Sku', data: ReportSkuModel }"></div>
    </div>
</script>


<script>
    ProfitWiseWidgets = ProfitWiseWidgets || {};

    ProfitWiseWidgets.ReportEditorModel = function () {
        var self = this;

        // Bind the C# internal name
        self.ProductTypeFilter = "@PwReportFilter.ProductType";
        self.VendorFilter = "@PwReportFilter.Vendor";
        self.ProductFilter = "@PwReportFilter.Product";
        self.SkuFilter = "@PwReportFilter.Sku";

        self.ReportId = ko.observable();
        self.SelectedFilterModel = ko.observable();

        self.FiltersGrid = ko.observableArray([]);

        self.CancelCallback = function () { };

        self.OkCallback = function () { };

        self.OkButtonClick = function () {
            self.ClickOnNewFilterTab();
            self.OkCallback();
        };

        self.CancelButtonClick = function() {
            self.CancelCallback();
        };

        self.RefreshFilterSummary = function (callback) {
            flow.exec(
                function() {
                    var ajax = new ProfitWiseFunctions.Ajax();
                    ajax.HttpGet("/ReportService/Filters?reportId=" + self.ReportId(), this);
                },
                function (filters) {
                    self.FiltersGrid(filters);
                    if (callback) {
                        callback();
                    }
                }
            );
        };

        self.RemoveFilter = function(item) {
            flow.exec(
                function () {
                    var ajax = new ProfitWiseFunctions.Ajax();
                    var data = {
                        reportId: self.ReportId(),
                        filterId: item.PwFilterId,
                    };
                    ajax.HttpPost(
                        "/ReportService/RemoveFilterById",
                        data, this);
                },
                function () {
                    var selectionModel = self.SelectionModelByFilterType(item.FilterType);
                    if (selectionModel) {
                        selectionModel.SetCheckedItemByKey(item.Key, false);
                    }
                    //self.RefreshFilterSummary();
                    self.FiltersGrid.remove(item);
                }
            );
        };



        self.ClickOnNewFilterTab = function (newFilterModel, newTabRefreshFunction, bootstrapTabHref) {
            flow.exec(
                function() {
                    if (self.SelectedFilterModel() == newFilterModel) {
                        return;
                    }
                    newTabRefreshFunction(this);
                },
                function() {
                    self.SelectedFilterModel(newFilterModel);
                    ProfitWiseFunctions.BsActivateTab(bootstrapTabHref);
                }
            );
        };

        self.ProductTypeClick = function () {
            self.ClickOnNewFilterTab(
                self.ReportProductTypeModel,
                function(callback) { self.ReportProductTypeModel.Refresh(self.ReportId(), callback); },
                "report-filter-product-type");
        };

        self.VendorClick = function() {
            self.ClickOnNewFilterTab(
                self.ReportVendorModel,
                function(callback) { self.ReportVendorModel.Refresh(self.ReportId(), callback); },
                "report-filter-vendor");
        };

        self.MasterProductClick = function () {
            self.ClickOnNewFilterTab(
                self.ReportMasterProductModel,
                function (callback) { self.ReportMasterProductModel.Refresh(self.ReportId(), callback); },
                "report-filter-product");
        };

        self.SkuClick = function () {
            self.ClickOnNewFilterTab(
                self.ReportSkuModel,
                function (callback) { self.ReportSkuModel.Refresh(self.ReportId(), callback); },
                "report-filter-sku");
        };


        self.RegisterCancelCallback = function (callback) {
            self.CancelCallback = callback;
        };
        self.RegisterOkCallback = function (callback) {
            self.OkCallback = callback;
        };

        self.LoadReport = function (reportId) {
            self.ReportId(reportId);
            self.ProductTypeClick();
        };

        // Wire in the individual Report Editor modules
        self.ReportProductTypeModel = new ProfitWiseWidgets.ReportProductTypeModel(self);
        self.ReportVendorModel = new ProfitWiseWidgets.ReportVendorModel(self);
        self.ReportMasterProductModel = new ProfitWiseWidgets.ReportMasterProductModel(self);
        self.ReportSkuModel = new ProfitWiseWidgets.ReportSkuModel(self);


        self.SelectionModelByFilterType = function(filterType) {
            if (filterType == self.ProductTypeFilter) {
                return self.ReportProductTypeModel.SelectionModel;
            }
            if (filterType == self.VendorFilter) {
                return self.ReportVendorModel.SelectionModel;
            }
            if (filterType == self.ProductFilter) {
                return self.ReportMasterProductModel.SelectionModel;
            }
            if (filterType == self.SkuFilter) {
                return self.ReportSkuModel.SelectionModel;
            }

        };


        return self;
    };
</script>

