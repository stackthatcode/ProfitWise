@using ProfitWise.Data.Model.Preferences
@using Push.Foundation.Web.Json
@model ProfitWise.Data.Model.Shop.PwShop
@{
    Layout = "~/Views/Shared/_AuthenticatedLayout.cshtml";
}
@Html.Partial("~/Views/Report/_DatePickerWidget.cshtml")
@Html.Partial("~/Views/SharedTemplates/_NumberEditorWidget.cshtml")

<style>
    .vert-spacer { height:65px; }
    .preference-control-cell { padding-left:40px; }
</style>

<script type="text/html" id="Main-Template">
    <div class="std-outer-padding">
        <div class="standard-header-sleeve" style="height: 150px;">
            <!-- This element will track with the scrollbar via JavaScript wiring to onscroll-->
            <div class="standard-header top-border-facade std-inner-padding">
                <div class="row">
                    <div class="col-xs-12" style="padding-top:20px;">
                        <h2 styl="font-weight:700;">Profitwise &gt; Edit Preferences</h2>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="page-content-sleeve">
        <div class="page-content std-inner-padding" style="min-height: 400px; padding-bottom: 100px;">
            <div data-bind="template: { name: 'Page-Content' }"></div>
        </div>
    </div>
</script>

<script type="text/html" id="Order-Start-Date">    
    <div class="form-group" style="display:inline-block;">
        <label>Starting Date For Importing Historical Data</label>
        
        <div style="width:200px; display:inline-block; margin-left: 20px; top:10px; position:relative;">
            <div class='input-group date' 
                 data-bind="dateTimePicker: StartingDateForOrders, 
                            change: function(value) { },
                            dateTimePickerOptions: { format: 'MM/DD/YYYY' }">

                <input type='text' class="form-control" 
                       data-bind="click: function(data, event) { $(event.target).next().click(); }" />
                
                <span class="input-group-addon">
                    <span class="glyphicon glyphicon-calendar"></span>
                </span>
            </div>
        </div>
    </div>
</script>

<script type="text/html" id="Page-Content">
    <div class="row">
        <div class="col-xs-12">
            <div data-bind="template: { name: 'Order-Start-Date', afterRender: DatePickerRender }"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-12">
            <div class="vert-spacer"></div>
        </div>
    </div>    

    <div class="row">
        <div class="col-xs-12">
            <label>Use Default Margin in Reports for all $0 CoGS</label>

            <div style="display:inline-block; width:125px; margin-left:30px; position:relative;">
                <select class="form-control">
                    <option>Yes</option>
                    <option>No</option>
                </select>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-12">
            <div style="height:10px;"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-12">
            <label>Default Margin</label>

            <div style="display:inline-block; width:90px; margin-left:30px; position:relative; top:13px;">
                <div data-bind="template: { name: 'Number-Editor-Widget', data: $root.DefaultMarginEditor }"></div>
            </div>

            <div style="display:inline-block; margin-left:10px; position:relative;">
                <a href="#" class="btn btn-primary" style="width:100px; display:inline-block;">
                    Save &nbsp;<i class="glyphicon glyphicon-floppy-disk"></i>
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-12">
            <div style="height:20px;"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-12">
            <label>Bulk apply value to all CoGS Data</label>

            <div style="display:inline-block; margin-left:10px; position:relative;">
                <a href="#" class="btn btn-warning" data-bind="click: BulkEditAllCogsDialogPopup"
                   style="width:200px; display:inline-block; margin-top:-4px;">
                    Bulk Set CoGS Data &nbsp;<i class="glyphicon glyphicon-list"></i>
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-12">
            <div class="vert-spacer"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-12">
            <label>When should revenues/profits be recognized for orders?</label>

            <div class="preference-control-cell">
                <div class="radio">
                    <label>
                        <input type="radio" name="optionsRadios"
                               value="@ProfitRealization.OrderReceived" checked>
                        When the order is created
                    </label>
                </div>
                <div class="radio">
                    <label>
                        <input type="radio" name="optionsRadios"
                               value="@ProfitRealization.PaymentClears">
                        When payment for the order is captured
                    </label>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-12">
            <div style="height:20px;"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-12">
            <label>Default Date Range for Dashboard</label>
            <div class="preference-control-cell" data-bind="foreach: DateRangeOptions">
                <div class="radio">
                    <label>
                        <input type="radio" name="defaultDateRadio" data-bind="value: $data.Id" value="option1" checked>
                        <span data-bind="text: $data.Name"></span>
                    </label>
                </div>
            </div>
        </div>
    </div>
</script>

<!-- KnockoutJS Root View -->
<div data-bind="template: { name: 'Main-Template' }">
</div>

<!-- KnockoutJS Model -->
<script>
    var ProfitWise = ProfitWise || {};
    ProfitWise.EditPreferencesModel = function (initialValues) {
        var self = this;
        self.DateRangeOptions = ProfitWiseWidgets.DateRanges;

        self.DatePickerRender = function () {
            //$('#datetimepicker1').datetimepicker();
            //$('#datetimepicker1').data("DateTimePicker").date(self.StartingDateForOrders());
        };

        // This must be populated with Javascript Date object
        self.StartingDateForOrders = ko.observable(
                initialValues.StartingDateForOrders.parseDateToStartOfDayLocalTime());
        
        self.UseDefaultMargin = ko.observable(initialValues.UseDefaultMargin);
        self.DefaultMargin = ko.observable(initialValues.DefaultMargin);
        self.ProfitRealization = ko.observable(initialValues.ProfitRealization);
        self.DateRangeDefault = ko.observable(initialValues.DateRangeDefault);

        self.DefaultMarginEditor =
            new ProfitWiseWidgets.NumberEditorWidgetModel({
                identifier: "number-editor",
                placeholder: "Margin %",
                lowconstraint: 0,
                highconstraint: 100
            });
        
        self.BulkEditAllCogsDialogPopup = function () {
            var url = ProfitWiseConfig.BaseUrl + '/Preferences/BulkEditAllCogs';

            ProfitWiseShopify.LaunchModal({
                src: url,
                title: 'Bulk Edit All Cost of Goods Sold',
                width: 'small',
                height: 420,
            }, self.Refresh);
        };

        return self;
    };

    ko.bindingHandlers.dateTimePicker = {
        init: function (element, valueAccessor, allBindingsAccessor) {
            //initialize datepicker with some optional options
            var options = allBindingsAccessor().dateTimePickerOptions || {};
            $(element).datetimepicker(options);

            //when a user changes the date, update the view model
            ko.utils.registerEventHandler(element, "dp.change", function (event) {
                var value = valueAccessor();
                if (ko.isObservable(value)) {
                    if (event.date != null && !(event.date instanceof Date)) {
                        value(event.date.toDate());
                    } else {
                        value(event.date);
                    }
                }

                if (allBindingsAccessor().change) {
                    allBindingsAccessor().change(value());
                }
            });

            ko.utils.domNodeDisposal.addDisposeCallback(element, function () {
                var picker = $(element).data("DateTimePicker");
                if (picker) {
                    picker.destroy();
                }
            });
        },
        update: function (element, valueAccessor, allBindings, viewModel, bindingContext) {
            var picker = $(element).data("DateTimePicker");
            //when the view model is updated, update the widget
            if (picker) {
                var koDate = ko.utils.unwrapObservable(valueAccessor());

                //in case return from server datetime i am get in this form for example /Date(93989393)/ then fomat this
                koDate = (typeof (koDate) !== 'object') ? new Date(parseFloat(koDate.replace(/[^0-9]/g, ''))) : koDate;                
                picker.date(koDate);
            }
        }
    };

    $(document)
        .ready(function () {
            var data = @Html.Raw(Model.SerializeToJson());
            var model = new ProfitWise.EditPreferencesModel(data);
            
            ko.applyBindings(model);
        });
</script>

