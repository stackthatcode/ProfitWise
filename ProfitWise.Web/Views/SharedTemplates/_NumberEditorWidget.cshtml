<!-- Requires KnockoutJS Bootstrap integration plugin Knockstrap -->

<script type="text/html" id="Number-Editor-Widget">
    <div class="input-group">
        
        <input type="text"
               data-bind="formatNumber: Amount,
                        attr: { id: $data.Identifier, placeholder: $data.PlaceHolder },
                        event: { 
                            focus: function() { 
                                if (event) { 
                                    event.target.select();
                                }
                            }, 
                            keyup: InvokeKeyCallback,
                            blur: InvokeEditorLostFocusCallback }"
               class="form-control"
               placeholder="Enter Value"
               maxlength="12">
    </div>
</script>

<script type="text/javascript">
    var ProfitWiseWidgets = ProfitWiseWidgets || {};

    // Parameters = { identifier, placeholder, lowconstraint, highconstraint, defaultamount }
    ProfitWiseWidgets.NumberEditorWidgetModel = function(parameters) {
        var self = this;        
        
        self.Identifier = ko.observable(parameters.identifier);
        self.PlaceHolder = ko.observable(parameters.placeholder);
        self.Amount = ko.observable(numeral(parameters.defaultamount || 0).format('0,0.00'));


        ko.bindingHandlers.formatNumber = {
            init: function(element, valueAccessor) {
                var value = valueAccessor();
                var interceptor =
                    ProfitWiseFunctions.MakeKnockoutNumberOnlyInterceptor(
                    {
                        knockoutValue: value, 
                        lowConstraint: parameters.lowconstraint, 
                        highConstraint: parameters.highconstraint                         
                    });

                // Only apply bindings to node...?
                if (element.tagName.toLowerCase() == 'input') {
                    ko.applyBindingsToNode(element, { value: interceptor });
                } else {
                    ko.applyBindingsToNode(element, { text: interceptor });
                }
            }
        };

        self.SetFocus = function() { $("#" + self.Identifier()).focus(); };

        // Enter-key Stuff
        self.EnterKeyCallback = function () { };
        self.EscapeKeyCallback = function () { };
        self.EditorLostFocusCallback = function() {};

        self.RegisterEnterKeyCallback = function (callback) {
            self.EnterKeyCallback = callback;
        };

        self.RegisterEscapeKeyCallback = function (callback) {
            self.EscapeKeyCallback = callback;
        };

        self.RegisterEditorLostFocusCallback = function(callback) {
            self.EditorLostFocusCallback = callback;
        };

        self.InvokeKeyCallback = function (model, event) {
            if (event.keyCode == 27) {
                self.EscapeKeyCallback();
                return false;
            }
            if (event.keyCode == 13) {
                self.EnterKeyCallback();
                return false;
            } else {
                return true;
            }
        };

        self.InvokeEditorLostFocusCallback = function(model, event) {
            self.EditorLostFocusCallback();
        };

        return self;
    };
</script>
