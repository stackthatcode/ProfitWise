<!-- Requires KnockoutJS Bootstrap integration plugin Knockstrap -->

<style>
    .currency-popover a {
        text-decoration: none;
        color: #666;
        font-size: 0.9em;
        font-weight: 600;
        height: 22px;
        display: block;
    }
    .currency-popover a:hover {
        color: #999;
        text-decoration: none;
    }
</style>

<script type="text/html" id="Money-Editor-Widget-Popover">
    <div class="currency-popover" data-bind="foreach: ProfitWiseFunctions.CurrencyCache">
        <a href="#" data-bind="click: $parent.ChangeCurrencySelection">
            <span data-bind="text: Abbr" style="display: inline-block; width: 32px;"></span> (<span data-bind="text: Symbol"></span>) 
        </a>
    </div>
</script>

<script type="text/html" id="Money-Editor-Widget">
    <div class="input-group popover-container currency-widget">
        <div style="width: 70px;"
             class="input-group-addon popover-launcher"
             data-bind="text: SelectedCurrencyFriendly, 
                    popover: { options: { placement: 'bottom' , trigger: 'click' , }, template: 'Money-Editor-Widget-Popover', data: $data }">
        </div>
        <input type="text"
               data-bind="formatMoney: Amount,
                        event: { 
                            focus: function() { event.target.select(); }, 
                            keyup: InvokeKeyCallback,
                            blur: InvokeEditorLostFocusCallback }"
               class="form-control money-editor-text"
               placeholder="Enter CoGS"
               maxlength="12">
    </div>
</script>

<script type="text/javascript">
    var ProfitWiseWidgets = ProfitWiseWidgets || {};

    ProfitWiseWidgets.MoneyEditorWidgetModel = function(currencyId, amount) {
        var self = this;
        var defaultCurrencyId = 1;
        var defaultAmount = 0.00;
        
        // TODO: load this from the database...
        self.CurrencyCache = ProfitWiseFunctions.CurrencyCache;

        // Populate the input amounts
        self.CurrencyId = ko.observable(currencyId || defaultCurrencyId);   // Default to Currency Id = 1;
        self.Amount = ko.observable(numeral(amount || defaultAmount).format('0,0.00'));

        ko.bindingHandlers.formatMoney = {
            init: function(element, valueAccessor) {
                var value = valueAccessor();
                var interceptor = ko.computed({
                        read: function() {
                            // Here's the formatting injection point
                            var unwrapperValue = ProfitWiseFunctions.UnformatCurrency(ko.unwrap(value));
                            var output = numeral(unwrapperValue).format('0,0.00');
                            return output;
                        },
                        write: function(newValue) {
                            if ($.trim(newValue) == '')
                                value("0");
                            else
                                value(numeral().unformat(newValue));
                            value.valueHasMutated();
                        }
                    })
                    .extend({ notify: 'always' });

                // Only apply bindings to node...?
                if (element.tagName.toLowerCase() == 'input') {
                    ko.applyBindingsToNode(element, { value: interceptor });
                } else {
                    ko.applyBindingsToNode(element, { text: interceptor });
                }
            }
        };

        self.SelectedCurrency = ko.computed(function() {
            return AQ(ProfitWiseFunctions.CurrencyCache)
                .first(function (item) {
                    return item.Id == self.CurrencyId();
                });
        });
        
        self.SelectedCurrencyFriendly = ko.computed(function () {
            return self.SelectedCurrency().Abbr + " (" + self.SelectedCurrency().Symbol + ")";
        });

        self.ChangeCurrencySelection = function (model) {
            self.CurrencyId(model.Id);
            ProfitWiseFunctions.PopOverCloseAll();
            self.ChangeCurrencyCallback();
        };

        self.PushState = function(currencyId, amount) {
            self.CurrencyId(currencyId);
            self.Amount(amount);
        }

        self.PullState = function() {
            return {
                CurrencyId: self.CurrencyId(),
                Amount: self.Amount()
            };
        };

        
        // Enter-key Stuff
        self.EnterKeyCallback = function () { };
        self.EscapeKeyCallback = function () { };
        self.ChangeCurrencyCallback = function() {};
        self.EditorLostFocusCallback = function() {};

        self.RegisterEnterKeyCallback = function (callback) {
            self.EnterKeyCallback = callback;
        };

        self.RegisterEscapeKeyCallback = function (callback) {
            self.EscapeKeyCallback = callback;
        };

        self.RegisterChangeCurrencyCallback = function(callback) {
            self.ChangeCurrencyCallback = callback;
        };

        self.RegisterEditorLostFocusCallback = function(callback) {
            self.EditorLostFocusCallback = callback;
        };

        self.InvokeKeyCallback = function (model, event) {
            if (event.keyCode == 27) {
                self.EscapeKeyCallback();
                return false;
            }
            if (event.keyCode == 13) {
                self.EnterKeyCallback();
                return false;
            } else {
                return true;
            }
        };

        self.InvokeEditorLostFocusCallback = function(model, event) {
            self.EditorLostFocusCallback();
        };

        return self;
    };
</script>
