<style>
     #product-consol-grid td {
        height: 120px !important;
        font-size: 14px;
        vertical-align: middle !important;
    }

    #product-consol-grid th {
        font-size: 14px !important;
        font-weight: 700;
        color: #777;
        height: 50px;
    }

    /*
    #product-edit-heading tr th { border-bottom: none; }
    #product-edit-grid tr td:nth-child(1), #product-edit-heading tr th:nth-child(1) { width: 40%; }
    #product-edit-grid tr td:nth-child(2), #product-edit-heading tr th:nth-child(2) { width: 20%; text-align: center; }
    #product-edit-grid tr td:nth-child(3), #product-edit-heading tr th:nth-child(3) { width: 20%; text-align: center; }
    #product-edit-grid tr td:nth-child(4), #product-edit-heading tr th:nth-child(4) { width: 10%; text-align: center; }
    #product-edit-grid tr td:nth-child(5), #product-edit-heading tr th:nth-child(5) { width: 10%; text-align: center; }
    */

    input[type='text'] { width: 100px; }
</style>


<script type="text/html" id="Product-Consolidation-Header">
    <!-- Filtering and Paging -->
    <div class="row">
        <div class="col-xs-6" style="padding-top: 20px;">
            
            <h3 class="edit-product-header overflow-gracefully" 
                data-bind="text: MasterProductTitle"></h3>
            <div class="edit-product-subtitle" data-bind="text: VariantTitle"></div>
            
            <div class="edit-product-spacer"></div>

            <div class="return-link">
                <i class="glyphicon glyphicon-arrow-left"></i> &nbsp;
                <a href="#" data-bind="click: ExitCallback">
                    Return to Product Search
                </a>
            </div>
        </div>
        
        <div class="col-xs-6" style="text-align: right; padding-top: 40px;">
            <a href="#" class="btn btn-primary" style="width:250px;" data-bind="click: EditCogsCallback">
                <i class="glyphicon glyphicon-pencil"></i> Cost of Goods Sold
            </a>
        </div>
    </div>

    <div class="row" data-bind="visible: $data.Grid().length > 0">
        <div class="col-xs-12" style="height:57px; border-bottom:1px solid #CCC;">
            <table class="table" id="product-edit-heading" style="margin-bottom: 0px;">
                <thead>
                <tr>
                    <th>
                        <span data-bind="template: { name: 'Sortable-Column-Header',
                                data: { ColumnIndex: 0, ColumnName: 'Sku', Model: $data.SortingModel } }">
                        </span>
                        <span>&nbsp;/&nbsp;</span>
                        <span data-bind="template: { name: 'Sortable-Column-Header',
                                data: { ColumnIndex: 1, ColumnName: 'Title', Model: $data.SortingModel } }">
                        </span>
                    </th>
                    <th>Price</th>  
                                      
                    <th>
                        <a href="#" data-bind="click: function() { $data.CogsDetailForProduct(); }">
                            Cost of Goods Sold
                        </a>
                    </th>
                    
                    <th style="text-align: center;">
                        <a href="#" data-bind="click: function() { $data.StockedDirectlyDialogPopup(); }">
                            Stocked<br />Directly
                        </a>
                    </th>
                    <th style="text-align: center;">
                        <a href="#" data-bind="click: function() { $data.ExcludedDialogPopup(); }">Exclude</a>
                    </th>
                </tr>
                </thead>
            </table>
        </div>
    </div>
</script>

<script type="text/html" id="Product-Consolidation-Body">
    <h1>Product Consolidation Stuff All Right Here!!!</h1>
    <h1>Product Consolidation Stuff All Right Here!!!</h1>
    <h1>Product Consolidation Stuff All Right Here!!!</h1>

</script>

<script>
    var ProfitWise = ProfitWise || {};

    // parameters = exitcallback, editcogscallback
    ProfitWise.EditProductConsolidationModel = function (parameters) {
        var self = this;

        self.ExitCallback = parameters.exitcallback || function () { };
        self.EditCogsCallback = parameters.editcogscallback || function () { };

        self.PwMasterProductId = ko.observable(null);
        self.MasterProductTitle = ko.observable("");

        self.Grid = ko.observable([]);
        self.SortingModel = new ProfitWiseWidgets.SortingModel();

        self.RefreshSort = function() {
            var gridData = self.Grid();

            var columnLambda =
                (self.SortingModel.SelectedColumnIndex() == 0)
                    ? function(n) { return n.Sku; }
                    : function (n) { return n.Title; };

            if (self.SortingModel.SortByDirectionDown()) {
                self.Grid(AQ(gridData).orderBy(columnLambda).toArray());
            } else {
                self.Grid(AQ(gridData).orderByDescending(columnLambda).toArray());
            }
        }

        self.SortingModel.Callback = function () {
            self.RefreshSort();
        };

        // *** Sorting stuff...
        self.VariantTitle = ko.computed(function () {
            return self.Grid().length + " Variant(s)";
        });

        self.RetrieveMasterProduct = function (pwMasterProductId, callback) {
            flow.exec(
                function () {
                    self.PwMasterProductId(pwMasterProductId);
                    var settings = new ProfitWiseFunctions.AjaxSettings();
                    var ajax = new ProfitWiseFunctions.Ajax(settings);
                    var url = "/CogsService/RetrieveMasterProduct?pwMasterProductId=" + self.PwMasterProductId();
                    ajax.HttpGet(url, this);
                },
                function (data) {
                    if (!data.MasterProduct) {
                        self.ExitCallback();
                        return;
                    }

                    self.LoadMasterProduct(data);
                    if (callback) {
                        callback();
                    }
                });
        };

        self.LoadMasterProduct = function (data) {
            self.MasterProductTitle(data.MasterProduct.Title);

            // TODO - wire in goodness
            //AQ(data.MasterProduct.MasterVariants);

            self.Grid(data.MasterProduct.MasterVariants);
            self.RefreshSort();
        };


        self.Refresh = function() {
            self.RetrieveMasterProduct(self.PwMasterProductId());
        };
        
        self.SearchForProductsPopup = function (pwMasterVariantId, pwMasterProductId, dialogTitle) {
            var url = ProfitWiseConfig.BaseUrl +
                '/Cogs/CogsDetail?pwMasterVariantId=' + pwMasterVariantId + "&pwMasterProductId=" + pwMasterProductId;
            
            ProfitWiseShopify.LaunchModal({
                src: url,
                title: 'Edit CoGS Detail: ' + dialogTitle,
                width: 'large',
                height: 500,
            }, self.Refresh);
        }


        // Some JQuery initialization
        self.JQueryInit = function() {
            ProfitWiseFunctions.SynchronizeWidth(
                "table#product-edit-grid tbody tr td",
                "table#product-edit-heading thead tr th");
        };

        return self;
    };
</script>